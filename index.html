<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pohybov√© aktivity v2 ‚Äî Dƒõtsk√° l√©ƒçebna K≈ôet√≠n</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--green:#4CAF50;--green-light:#E8F5E9;--blue:#2196F3;--blue-light:#E3F2FD;--orange:#FF9800;--orange-light:#FFF3E0;--purple:#9C27B0;--purple-light:#F3E5F5;--red:#F44336;--gray:#757575;--gray-light:#F5F5F5;--white:#FFFFFF;--shadow:0 2px 8px rgba(0,0,0,0.1);--shadow-lg:0 4px 16px rgba(0,0,0,0.15);--radius:12px;--radius-sm:8px}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#E8F5E9 0%,#E3F2FD 100%);min-height:100vh;color:#333;line-height:1.5}
.app-container{max-width:600px;margin:0 auto;padding:16px;padding-bottom:80px}
.app-container.admin-wide{max-width:960px}
.app-header{display:flex;align-items:center;gap:12px;padding:16px;background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:16px}
.app-header img{height:48px;width:auto}
.app-header .title-wrap h1{font-size:1.1rem;color:var(--green);line-height:1.2}
.app-header .title-wrap p{font-size:.75rem;color:var(--gray)}
.screen{display:none}.screen.active{display:block}
.card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin-bottom:16px}
.card h2{font-size:1.1rem;margin-bottom:12px;color:var(--blue)}
.card h3{font-size:.95rem;margin-bottom:8px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:12px 24px;border:none;border-radius:var(--radius-sm);font-size:1rem;font-weight:600;cursor:pointer;transition:transform .1s,box-shadow .2s;text-decoration:none;color:var(--white)}
.btn:active{transform:scale(.97)}
.btn-green{background:var(--green)}.btn-blue{background:var(--blue)}.btn-orange{background:var(--orange)}.btn-purple{background:var(--purple)}.btn-red{background:var(--red)}.btn-gray{background:var(--gray)}
.btn-outline{background:transparent;border:2px solid var(--blue);color:var(--blue)}
.btn-block{display:flex;width:100%}.btn-sm{padding:8px 14px;font-size:.85rem}
.form-group{margin-bottom:14px}
.form-group label{display:block;font-weight:600;margin-bottom:4px;font-size:.9rem;color:#555}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 14px;border:2px solid #E0E0E0;border-radius:var(--radius-sm);font-size:1rem;transition:border-color .2s;font-family:inherit}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--blue)}
.option-group{display:flex;gap:8px;flex-wrap:wrap}
.option-btn{flex:1;min-width:80px;padding:10px;border:2px solid #E0E0E0;border-radius:var(--radius-sm);background:var(--white);text-align:center;cursor:pointer;font-size:.9rem;font-weight:600;transition:all .2s}
.option-btn.selected{border-color:var(--blue);background:var(--blue-light);color:var(--blue)}
.option-btn:hover{border-color:var(--blue)}
.activity-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.activity-tile{padding:12px 8px;border-radius:var(--radius-sm);text-align:center;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s;border:2px solid transparent;position:relative}
.activity-tile.pts-10{background:var(--green-light);color:#2E7D32;border-color:#C8E6C9}
.activity-tile.pts-20{background:var(--orange-light);color:#E65100;border-color:#FFE0B2}
.activity-tile.pts-30{background:var(--purple-light);color:#6A1B9A;border-color:#E1BEE7}
.activity-tile .tile-icon{display:block;font-size:1.6rem;margin-bottom:2px}
.activity-tile .tile-meta{font-size:.65rem;color:var(--gray);font-weight:400}
.activity-tile .tile-capacity{font-size:.7rem;margin-top:4px;font-weight:700}
.activity-tile .tile-capacity.full{color:var(--red)}
.activity-tile:hover{transform:scale(1.03);box-shadow:var(--shadow)}
.activity-tile.done{border-color:var(--green);box-shadow:0 0 0 2px var(--green)}
.activity-tile.done::after{content:'\2713';position:absolute;top:4px;right:6px;font-size:.8rem;font-weight:700;color:var(--green)}
.activity-tile.locked{opacity:.35;cursor:not-allowed;pointer-events:none}
.activity-tile.done.cancellable{cursor:pointer}
.avatar{width:64px;height:64px;border-radius:50%;background:var(--blue-light);display:flex;align-items:center;justify-content:center;font-size:1.8rem;overflow:hidden;flex-shrink:0}
.avatar img{width:100%;height:100%;object-fit:cover}
.avatar-large{width:80px;height:80px;font-size:2.2rem}
.dash-hero{display:flex;align-items:center;gap:16px;margin-bottom:16px}
.dash-hero .info h2{color:#333;margin-bottom:2px}
.dash-hero .info p{font-size:.85rem;color:var(--gray)}
.points-badge{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,var(--orange),#F57C00);color:var(--white);padding:6px 14px;border-radius:20px;font-weight:700;font-size:1.1rem;margin-top:6px}
.today-list{list-style:none}
.today-list li{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f0f0f0;font-size:.9rem}
.today-list li:last-child{border-bottom:none}
.today-list .remove-btn{background:none;border:none;color:var(--red);cursor:pointer;font-size:1.1rem;padding:2px 6px;border-radius:4px}
.today-list .remove-btn:hover{background:#FFEBEE}
.quick-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.quick-action{display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px;border-radius:var(--radius);cursor:pointer;border:none;font-weight:700;font-size:.9rem;transition:transform .1s;color:var(--white)}
.quick-action:active{transform:scale(.97)}.quick-action .icon{font-size:1.8rem}
.km-display{text-align:center;font-size:3rem;font-weight:700;color:var(--blue);margin:16px 0}
.km-display small{font-size:1.2rem;color:var(--gray)}
.km-slider{width:100%;height:8px;-webkit-appearance:none;appearance:none;background:#E0E0E0;border-radius:4px;outline:none}
.km-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:32px;height:32px;border-radius:50%;background:var(--blue);cursor:pointer;box-shadow:var(--shadow)}
.km-buttons{display:flex;justify-content:center;gap:8px;margin-top:12px;flex-wrap:wrap}
.filter-bar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px}
.filter-btn{padding:6px 12px;border:2px solid #E0E0E0;border-radius:20px;background:var(--white);font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s}
.filter-btn.active{border-color:var(--blue);background:var(--blue-light);color:var(--blue)}
.lb-chart{display:flex;align-items:flex-end;gap:6px;padding:8px 0;overflow-x:auto;-webkit-overflow-scrolling:touch;min-height:180px}
.lb-bar{display:flex;flex-direction:column;align-items:center;flex:1;min-width:60px;max-width:90px}
.lb-bar-top{display:flex;flex-direction:column;align-items:center;margin-bottom:4px}
.lb-bar-top .avatar{width:34px;height:34px;font-size:1rem;margin-bottom:2px}
.lb-bar-name{font-size:.7rem;font-weight:700;text-align:center;line-height:1.1;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lb-bar-sub{font-size:.6rem;color:var(--gray);font-weight:400}
.lb-bar-col{width:100%;border-radius:6px 6px 0 0;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding:6px 2px;min-height:30px;transition:height .4s ease}
.lb-bar-col .bar-pts{font-size:.8rem;font-weight:800;color:var(--white);text-shadow:0 1px 2px rgba(0,0,0,.2)}
.lb-bar-col .bar-rank{font-size:.95rem;margin-bottom:2px}
.lb-bar-col.bar-1{background:linear-gradient(180deg,#FFD54F,#F9A825)}
.lb-bar-col.bar-2{background:linear-gradient(180deg,#E0E0E0,#9E9E9E)}
.lb-bar-col.bar-3{background:linear-gradient(180deg,#FFAB91,#D84315)}
.lb-bar-col.bar-rest{background:linear-gradient(180deg,#90CAF9,#1E88E5)}
.group-comparison{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.group-card{padding:14px;border-radius:var(--radius-sm);text-align:center;font-weight:700}
.group-card .group-name{font-size:.85rem;margin-bottom:4px}
.group-card .group-pts{font-size:1.4rem}
.group-card .group-avg{font-size:.75rem;font-weight:400;color:var(--gray)}
.profiles-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:12px}
.profile-icon{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 4px;border-radius:var(--radius);cursor:pointer;transition:all .2s;border:2px solid transparent;text-align:center}
.profile-icon:hover{border-color:var(--blue);background:var(--blue-light)}
.profile-icon .avatar{width:52px;height:52px;font-size:1.6rem}
.profile-icon .profile-name{font-size:.75rem;font-weight:700;line-height:1.1;word-break:break-word}
.profile-icon .profile-pts{font-size:.65rem;color:var(--orange);font-weight:700}
.profile-detail-header{display:flex;align-items:center;gap:14px;margin-bottom:12px}
.profile-detail-header .avatar{width:64px;height:64px;font-size:1.8rem}
.profile-detail-header .pd-info h3{font-size:1rem;margin-bottom:2px}
.profile-detail-header .pd-info p{font-size:.8rem;color:var(--gray)}
.profile-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px}
.profile-stat{text-align:center;padding:10px 6px;border-radius:var(--radius-sm);background:var(--gray-light)}
.profile-stat .stat-val{font-size:1.3rem;font-weight:800;display:block}
.profile-stat .stat-label{font-size:.65rem;color:var(--gray);font-weight:600}
.profile-day{padding:8px 0;border-bottom:1px solid #f0f0f0}
.profile-day:last-child{border-bottom:none}
.profile-day-date{font-weight:700;font-size:.85rem;margin-bottom:4px;color:#555}
.profile-day-items{display:flex;flex-wrap:wrap;gap:4px}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--white);box-shadow:0 -2px 8px rgba(0,0,0,.1);display:flex;justify-content:space-around;padding:6px 0 env(safe-area-inset-bottom,6px);z-index:100}
.nav-btn{display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px;border:none;background:none;font-size:.6rem;color:var(--gray);cursor:pointer;font-weight:600;transition:color .2s}
.nav-btn .nav-icon{font-size:1.2rem}.nav-btn.active{color:var(--blue)}
.admin-tabs{display:flex;gap:4px;overflow-x:auto;-webkit-overflow-scrolling:touch;margin-bottom:16px;padding-bottom:4px}
.admin-tab{padding:8px 14px;border:2px solid #E0E0E0;border-radius:20px;background:var(--white);font-size:.8rem;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .2s}
.admin-tab.active{border-color:var(--blue);background:var(--blue-light);color:var(--blue)}
.admin-tab-content{display:none}.admin-tab-content.active{display:block}
.educator-card{background:var(--gray-light);border-radius:var(--radius-sm);padding:14px;margin-bottom:12px}
.educator-card .edu-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.educator-card .edu-name{font-weight:700;font-size:1rem}
.edu-chips-group{margin-bottom:6px}.edu-chips-group-label{font-size:.75rem;font-weight:700;margin-bottom:4px;color:var(--gray)}.edu-chips{display:flex;flex-wrap:wrap;gap:6px}.edu-chip{display:inline-flex;align-items:center;gap:3px;cursor:pointer;padding:4px 10px;border-radius:16px;font-size:.8rem;font-weight:600;user-select:none;transition:all .15s}.edu-chip.inactive{background:var(--gray-light);color:var(--gray)}.edu-chip.pts-10{background:var(--green);color:#fff}.edu-chip.pts-20{background:var(--orange);color:#fff}.edu-chip.pts-30{background:var(--purple);color:#fff}
.edu-check-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
.edu-check-card{padding:10px 12px;border-radius:var(--radius-sm);border:2px solid #E0E0E0;background:var(--white);cursor:pointer;transition:all .2s}
.edu-check-card.checked{border-color:var(--blue);background:var(--blue-light)}
.edu-check-card .edu-check-header{display:flex;align-items:center;gap:8px;font-size:.85rem;font-weight:600}
.edu-check-card .edu-check-header input[type="checkbox"]{margin:0}
.edu-check-card .edu-inline-activities{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
.schedule-slot{background:var(--white);border:2px solid #E0E0E0;border-radius:var(--radius-sm);padding:12px;margin-bottom:8px;cursor:pointer;transition:all .2s}
.schedule-slot.selected{border-color:var(--green);background:var(--green-light)}
.schedule-slot.conflict{border-color:var(--red);background:#FFEBEE}
.schedule-slot .slot-info{font-size:.8rem;color:var(--gray);margin-top:4px}
.tag{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:12px;font-size:.75rem;font-weight:600}
.tag-green{background:var(--green-light);color:#2E7D32}
.tag-orange{background:var(--orange-light);color:#E65100}
.tag-purple{background:var(--purple-light);color:#6A1B9A}
.tag-blue{background:var(--blue-light);color:#1565C0}
.tag .remove-tag{cursor:pointer;margin-left:2px;font-weight:700}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.stat-card{padding:14px;border-radius:var(--radius-sm);text-align:center}
.stat-card .stat-num{font-size:1.6rem;font-weight:800;display:block}
.stat-card .stat-lbl{font-size:.75rem;color:var(--gray)}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center;padding:16px}
.modal-overlay.open{display:flex}
.modal{background:var(--white);border-radius:var(--radius);padding:24px;max-width:480px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
.modal h2{margin-bottom:16px}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:#333;color:#fff;padding:10px 20px;border-radius:20px;font-size:.9rem;font-weight:600;opacity:0;transition:all .3s;z-index:300;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.child-list{list-style:none;max-height:300px;overflow-y:auto}
.child-list-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:var(--radius-sm);cursor:pointer;transition:background .2s;border:2px solid transparent}
.child-list-item:hover{background:var(--blue-light);border-color:var(--blue)}
.child-list-item .avatar{width:40px;height:40px;font-size:1.2rem}
.child-list-item .cl-info{flex:1;font-weight:600;font-size:.9rem}
.child-list-item .cl-info small{font-weight:400;color:var(--gray);display:block;font-size:.75rem}
.photo-upload{display:flex;align-items:center;gap:12px}
.photo-upload .avatar{cursor:pointer}
.photo-upload input[type="file"]{display:none}
.photo-upload .upload-hint{font-size:.8rem;color:var(--gray)}
.warning-box{padding:12px;border-radius:var(--radius-sm);background:#FFEBEE;color:#C62828;font-weight:600;margin-bottom:12px;font-size:.9rem}
.info-box{padding:12px;border-radius:var(--radius-sm);background:var(--blue-light);color:#1565C0;font-weight:600;margin-bottom:12px;font-size:.9rem}
.success-box{padding:12px;border-radius:var(--radius-sm);background:var(--green-light);color:#2E7D32;font-weight:600;margin-bottom:12px;font-size:.9rem}
.text-center{text-align:center}.mt-8{margin-top:8px}.mt-12{margin-top:12px}.mt-16{margin-top:16px}.mb-8{margin-bottom:8px}.mb-16{margin-bottom:16px}
.flex-between{display:flex;justify-content:space-between;align-items:center}
.empty-state{text-align:center;padding:24px;color:var(--gray);font-size:.9rem}
.empty-state .empty-icon{font-size:2.5rem;margin-bottom:8px}
.divider{height:1px;background:#eee;margin:12px 0}
.overview-slot{padding:12px;margin-bottom:10px;border-radius:var(--radius-sm);background:var(--white);border-left:4px solid var(--gray)}
.overview-slot.pts-10{border-left-color:var(--green)}.overview-slot.pts-20{border-left-color:var(--orange)}.overview-slot.pts-30{border-left-color:var(--purple)}
.overview-slot-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.overview-slot-header strong{font-size:.9rem}
.overview-slot-count{font-size:.8rem;font-weight:700;color:var(--green)}.overview-slot-count.full{color:var(--red)}
.overview-slot-edu{font-size:.8rem;color:var(--gray);margin-bottom:6px}
.overview-children{display:flex;flex-wrap:wrap;gap:8px}
.overview-child{display:flex;flex-direction:column;align-items:center;gap:2px;width:48px}
.overview-child .avatar{width:28px;height:28px;font-size:.8rem}
.overview-child .avatar img{width:100%;height:100%;object-fit:cover}
.overview-child span{font-size:.6rem;text-align:center;line-height:1.1;word-break:break-word;max-width:48px}
.overview-unsigned{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px}
.sub-filter-row{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
.admin-record{margin-bottom:10px;padding:12px;border-radius:var(--radius-sm);background:var(--gray-light)}
.admin-record summary{font-weight:600;cursor:pointer;padding:4px 0}
.admin-day-record{display:flex;flex-wrap:wrap;gap:4px;align-items:center;padding:6px 0;border-bottom:1px solid #eee;font-size:.85rem}
.program-range-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:12px}
.program-range-row .form-group{flex:1;min-width:130px;margin-bottom:0}
.program-info-row{font-size:.85rem;color:var(--gray);margin-bottom:10px}
.variant-toggle{display:inline-flex;border:2px solid #E0E0E0;border-radius:var(--radius-sm);overflow:hidden;margin-bottom:12px}
.variant-toggle button{padding:6px 14px;border:none;background:var(--white);font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s;color:var(--gray)}
.variant-toggle button.active{background:var(--blue);color:var(--white)}
.day-selector-strip{display:flex;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:4px 0 8px}
.day-selector-grid{display:flex;flex-wrap:wrap;gap:6px;padding:4px 0 8px}
.day-tile{width:52px;height:56px;border-radius:var(--radius-sm);border:2px solid #E0E0E0;background:var(--white);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;flex-shrink:0;position:relative;padding:2px}
.day-tile:hover{border-color:var(--blue);box-shadow:var(--shadow)}
.day-tile .day-num{font-size:1.1rem;font-weight:800;line-height:1}
.day-tile .day-abbr{font-size:.6rem;color:var(--gray);font-weight:600;line-height:1.2}
.day-tile .day-act-count{font-size:.55rem;color:var(--green);font-weight:700;line-height:1}
.day-tile.selected{border-color:var(--blue);background:var(--blue-light)}
.day-tile.has-schedule{border-color:var(--green)}
.day-tile.selected.has-schedule{border-color:var(--blue);box-shadow:0 0 0 2px var(--green)}
.day-tile.weekend{background:#FAFAFA}
.day-tile.selected.weekend{background:var(--blue-light)}
.day-tile.today-marker::after{content:'';position:absolute;top:3px;right:3px;width:6px;height:6px;border-radius:50%;background:var(--red)}
@media(max-width:400px){.activity-grid{grid-template-columns:repeat(auto-fill,minmax(110px,1fr))}.quick-actions{grid-template-columns:1fr 1fr}.group-comparison{grid-template-columns:1fr}.app-header h1{font-size:.95rem}.admin-tab{font-size:.7rem;padding:6px 10px}.edu-check-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">
    <img src="https://kretin.detskelecebny.cz/visual/loga/logo_kretin.svg" alt="Logo" onerror="this.style.display='none'">
    <div class="title-wrap"><h1>Pohybov√© aktivity</h1><p>Dƒõtsk√° l√©ƒçebna K≈ôet√≠n ¬∑ 3.3. ‚Äì 31.3.2026</p></div>
  </div>

  <!-- AUTH -->
  <div id="screen-auth" class="screen active">
    <div class="card">
      <h2>V√≠tej!</h2>
      <p style="margin-bottom:16px;font-size:.9rem;color:var(--gray)">Zaregistruj se nebo se p≈ôihlas a zaƒçni sb√≠rat body za pohyb!</p>
      <button class="btn btn-green btn-block mb-8" onclick="showRegister()">Nov√° registrace</button>
      <button class="btn btn-blue btn-block mb-8" onclick="showLogin()">P≈ôihl√°sit se</button>
      <div class="divider"></div>
      <button class="btn btn-gray btn-block btn-sm" onclick="showAdminLogin()">Admin</button>
    </div>
    <div id="register-form" class="card" style="display:none">
      <h2>Registrace</h2>
      <div class="form-group"><label>Jm√©no / p≈ôezd√≠vka</label><input type="text" id="reg-name" placeholder="Tvoje jm√©no" maxlength="30"></div>
      <div class="form-group"><label>Pohlav√≠</label><div class="option-group" id="reg-gender"><div class="option-btn" data-val="kluk" onclick="selectOption(this)">Kluk</div><div class="option-btn" data-val="holka" onclick="selectOption(this)">Holka</div></div></div>
      <div class="form-group"><label>Vƒõk</label><input type="number" id="reg-age" placeholder="Kolik ti je?" min="4" max="18"></div>
      <div class="form-group"><label>Skupina</label><div class="option-group" id="reg-group"></div></div>
      <div class="form-group"><label>Podskupina</label><div class="option-group" id="reg-subgroup"></div></div>
      <div class="form-group"><label>PIN (4 ƒç√≠slice)</label><input type="password" id="reg-pin" placeholder="1234" maxlength="4" inputmode="numeric" pattern="[0-9]*"></div>
      <div class="form-group"><label>Fotka (volitelnƒõ)</label><div class="photo-upload"><div class="avatar" id="reg-avatar-preview" onclick="document.getElementById('reg-photo').click()">üì∑</div><input type="file" id="reg-photo" accept="image/*" onchange="previewPhoto(this)"><span class="upload-hint">Klikni na ikonu</span></div></div>
      <button class="btn btn-green btn-block mt-8" onclick="registerChild()">Zaregistrovat se</button>
      <button class="btn btn-outline btn-block btn-sm mt-8" onclick="hideRegister()">Zpƒõt</button>
    </div>
    <div id="login-form" class="card" style="display:none">
      <h2>P≈ôihl√°≈°en√≠</h2>
      <p style="font-size:.85rem;color:var(--gray);margin-bottom:12px">Vyber se ze seznamu:</p>
      <ul class="child-list" id="login-list"></ul>
      <div id="login-pin-wrap" style="display:none" class="mt-12">
        <div class="form-group"><label>Zadej PIN</label><input type="password" id="login-pin" placeholder="PIN" maxlength="4" inputmode="numeric" pattern="[0-9]*"></div>
        <button class="btn btn-blue btn-block" onclick="loginChild()">P≈ôihl√°sit</button>
      </div>
      <button class="btn btn-outline btn-block btn-sm mt-12" onclick="hideLogin()">Zpƒõt</button>
    </div>
    <div id="admin-login" class="card" style="display:none">
      <h2>Admin p≈ôihl√°≈°en√≠</h2>
      <div class="form-group"><label>Heslo</label><input type="password" id="admin-pass" placeholder="Zadejte heslo"></div>
      <button class="btn btn-gray btn-block" onclick="loginAdmin()">P≈ôihl√°sit</button>
      <button class="btn btn-outline btn-block btn-sm mt-8" onclick="hideAdminLogin()">Zpƒõt</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="screen-dashboard" class="screen">
    <div class="card">
      <div class="dash-hero">
        <div class="avatar avatar-large" id="dash-avatar"></div>
        <div class="info"><h2 id="dash-name"></h2><p id="dash-group"></p><div class="points-badge">‚≠ê <span id="dash-points">0</span> bod≈Ø</div></div>
      </div>
    </div>
    <div class="card">
      <div class="flex-between mb-8"><h2 style="margin-bottom:0">Dne≈°n√≠ z√°znamy</h2><span id="dash-date" style="font-size:.8rem;color:var(--gray)"></span></div>
      <ul class="today-list" id="dash-today-list"></ul>
      <div id="dash-today-empty" class="empty-state" style="display:none"><div class="empty-icon">üìù</div><p>Zat√≠m ≈æ√°dn√© z√°znamy. Pojƒè sportovat!</p></div>
    </div>
    <div class="card" id="dash-schedule-card">
      <h2>Dne≈°n√≠ nab√≠dka aktivit</h2>
      <div id="dash-schedule-preview"></div>
    </div>
    <div class="quick-actions" id="dash-quick-actions">
      <button class="quick-action" style="background:linear-gradient(135deg,var(--green),#388E3C)" onclick="showScreen('activities')"><span class="icon">üèÉ</span>Zapsat aktivitu</button>
      <button class="quick-action" style="background:linear-gradient(135deg,var(--blue),#1565C0)" onclick="showScreen('km')"><span class="icon">üö∂</span>Zapsat km</button>
    </div>
    <div id="dash-program-warning" class="warning-box" style="display:none;margin:0 0 12px 0"></div>
  </div>

  <!-- ACTIVITIES -->
  <div id="screen-activities" class="screen">
    <div class="card"><h2>Z√°znam aktivit</h2><div id="activity-info"></div></div>
    <div id="activity-slots-container"></div>
  </div>

  <!-- KM -->
  <div id="screen-km" class="screen">
    <div class="card" style="padding-top:0;overflow:hidden">
      <svg viewBox="0 0 600 200" style="width:100%;height:auto;display:block;margin:0 -20px;width:calc(100% + 40px)">
        <defs><linearGradient id="sky" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#87CEEB"/><stop offset="100%" stop-color="#E3F2FD"/></linearGradient><linearGradient id="hill1" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#66BB6A"/><stop offset="100%" stop-color="#388E3C"/></linearGradient><linearGradient id="hill2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#81C784"/><stop offset="100%" stop-color="#4CAF50"/></linearGradient><linearGradient id="hill3" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#A5D6A7"/><stop offset="100%" stop-color="#66BB6A"/></linearGradient></defs>
        <rect width="600" height="200" fill="url(#sky)"/><circle cx="520" cy="40" r="28" fill="#FFD54F"/>
        <g stroke="#FFD54F" stroke-width="3" fill="none"><line x1="520" y1="5" x2="520" y2="0"/><line x1="547" y1="13" x2="552" y2="8"/><line x1="555" y1="40" x2="560" y2="40"/><line x1="547" y1="67" x2="552" y2="72"/><line x1="520" y1="75" x2="520" y2="80"/><line x1="493" y1="67" x2="488" y2="72"/><line x1="485" y1="40" x2="480" y2="40"/><line x1="493" y1="13" x2="488" y2="8"/></g>
        <g fill="white" opacity=".8"><ellipse cx="120" cy="35" rx="35" ry="14"/><ellipse cx="100" cy="30" rx="20" ry="12"/><ellipse cx="140" cy="32" rx="22" ry="10"/><ellipse cx="350" cy="25" rx="28" ry="11"/><ellipse cx="335" cy="20" rx="18" ry="10"/><ellipse cx="370" cy="22" rx="20" ry="9"/></g>
        <path d="M0 160 Q80 80 200 120 Q320 60 420 110 Q520 70 600 100 L600 200 L0 200Z" fill="url(#hill1)"/>
        <g fill="#2E7D32"><polygon points="90,105 100,70 110,105"/><rect x="98" y="105" width="4" height="10" fill="#5D4037"/><polygon points="340,88 352,48 364,88"/><rect x="350" y="88" width="4" height="12" fill="#5D4037"/><polygon points="530,82 540,50 550,82"/><rect x="538" y="82" width="4" height="10" fill="#5D4037"/></g>
        <path d="M0 170 Q100 120 220 150 Q350 110 450 140 Q530 115 600 135 L600 200 L0 200Z" fill="url(#hill2)"/>
        <path d="M0 185 Q150 155 300 170 Q450 150 600 165 L600 200 L0 200Z" fill="url(#hill3)"/>
        <path d="M50 195 Q150 172 250 180 Q350 168 480 175" stroke="#C8B88A" stroke-width="4" fill="none" stroke-dasharray="8 4" opacity=".6"/>
        <g transform="translate(180,148)"><rect x="-5" y="8" width="10" height="16" rx="3" fill="#F06292"/><line x1="-3" y1="24" x2="-6" y2="34" stroke="#FFB74D" stroke-width="3" stroke-linecap="round"/><line x1="3" y1="24" x2="8" y2="33" stroke="#FFB74D" stroke-width="3" stroke-linecap="round"/><circle cx="-6" cy="35" r="2.5" fill="#7B1FA2"/><circle cx="8" cy="34" r="2.5" fill="#7B1FA2"/><line x1="-5" y1="12" x2="-14" y2="2" stroke="#FFB74D" stroke-width="3" stroke-linecap="round"/><line x1="5" y1="12" x2="14" y2="2" stroke="#FFB74D" stroke-width="3" stroke-linecap="round"/><circle cx="0" cy="2" r="8" fill="#FFB74D"/><path d="M-8 0 Q-8 -8 0 -8 Q8 -8 8 0" fill="#5D4037"/><circle cx="-3" cy="0" r="1" fill="#333"/><circle cx="3" cy="0" r="1" fill="#333"/><path d="M-3 4 Q0 7 3 4" stroke="#333" stroke-width=".8" fill="none"/></g>
        <g transform="translate(230,152)"><rect x="-5" y="8" width="10" height="15" rx="3" fill="#42A5F5"/><line x1="-3" y1="23" x2="-8" y2="32" stroke="#FFB74D" stroke-width="3" stroke-linecap="round"/><line x1="3" y1="23" x2="9" y2="31" stroke="#FFB74D" stroke-width="3" stroke-linecap="round"/><circle cx="-8" cy="33" r="2.5" fill="#1565C0"/><circle cx="9" cy="32" r="2.5" fill="#1565C0"/><line x1="-5" y1="12" x2="-13" y2="8" stroke="#FFB74D" stroke-width="3" stroke-linecap="round"/><line x1="5" y1="12" x2="13" y2="8" stroke="#FFB74D" stroke-width="3" stroke-linecap="round"/><circle cx="0" cy="2" r="8" fill="#FFB74D"/><path d="M-7 -2 Q-6 -9 0 -9 Q6 -9 7 -2" fill="#FFB300"/><circle cx="-3" cy="0" r="1" fill="#333"/><circle cx="3" cy="0" r="1" fill="#333"/><path d="M-3 4 Q0 7 3 4" stroke="#333" stroke-width=".8" fill="none"/><ellipse cx="0" cy="-7" rx="8" ry="3" fill="#F44336"/><rect x="-8" y="-9" width="16" height="3" rx="1" fill="#F44336"/></g>
        <g transform="translate(290,158)"><rect x="-4" y="6" width="8" height="12" rx="3" fill="#FF9800"/><line x1="-2" y1="18" x2="-8" y2="26" stroke="#FFB74D" stroke-width="2.5" stroke-linecap="round"/><line x1="2" y1="18" x2="10" y2="24" stroke="#FFB74D" stroke-width="2.5" stroke-linecap="round"/><circle cx="-8" cy="27" r="2" fill="#E65100"/><circle cx="10" cy="25" r="2" fill="#E65100"/><line x1="-4" y1="10" x2="-10" y2="5" stroke="#FFB74D" stroke-width="2.5" stroke-linecap="round"/><line x1="4" y1="10" x2="11" y2="14" stroke="#FFB74D" stroke-width="2.5" stroke-linecap="round"/><circle cx="0" cy="0" r="7" fill="#FFB74D"/><path d="M-6 -2 Q-5 -8 0 -8 Q5 -8 6 -2" fill="#D84315"/><circle cx="-2" cy="-1" r="1" fill="#333"/><circle cx="3" cy="-1" r="1" fill="#333"/><path d="M-2 3 Q.5 6 3 3" stroke="#333" stroke-width=".7" fill="none"/></g>
      </svg>
      <h2>Z√°znam kilometr≈Ø</h2>
      <p style="font-size:.85rem;color:var(--gray)">Kolik km jsi dnes nachodil/a?</p>
      <div id="km-lock-msg" class="warning-box" style="display:none">Z√°znam kilometr≈Ø je uzav≈ôen.<br><small style="font-weight:400">Kilometry lze zapisovat ka≈æd√Ω den do stanoven√© hodiny.</small></div>
      <div id="km-controls">
        <div class="km-display"><span id="km-value">0</span> <small>km</small></div>
        <input type="range" class="km-slider" id="km-slider" min="0" max="20" step="0.5" value="0" oninput="updateKmDisplay(this.value)">
        <div class="km-buttons"><button class="btn btn-sm btn-outline" onclick="adjustKm(-1)">-1</button><button class="btn btn-sm btn-outline" onclick="adjustKm(-0.5)">-0.5</button><button class="btn btn-sm btn-outline" onclick="adjustKm(0.5)">+0.5</button><button class="btn btn-sm btn-outline" onclick="adjustKm(1)">+1</button></div>
        <div class="mt-16 text-center"><p style="font-size:.85rem;color:var(--gray);margin-bottom:8px">Dnes zaps√°no: <strong id="km-today-saved">0</strong> km</p><button class="btn btn-blue btn-block" onclick="saveKm()">Ulo≈æit kilometry</button></div>
      </div>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div id="screen-leaderboard" class="screen">
    <div class="card"><h2>≈Ωeb≈ô√≠ƒçek</h2><div class="filter-bar" id="leaderboard-filters"></div><div class="sub-filter-row" id="subgroup-filters"></div><div id="leaderboard-chart" class="mt-12"></div></div>
    <div class="card"><h3 class="mb-8">Srovn√°n√≠ skupin</h3><div class="group-comparison" id="group-compare"></div></div>
    <div class="card"><h3 class="mb-8">Srovn√°n√≠ podskupin</h3><div class="group-comparison" id="subgroup-compare" style="grid-template-columns:1fr 1fr 1fr"></div></div>
  </div>

  <!-- PROFILES -->
  <div id="screen-profiles" class="screen">
    <div class="card"><h2>V≈°echny dƒõti</h2><div id="profiles-grid" class="profiles-grid"></div></div>
    <div id="profile-detail" style="display:none"></div>
  </div>

  <!-- ADMIN -->
  <div id="screen-admin" class="screen">
    <div class="card">
      <div class="flex-between mb-8"><h2 style="margin-bottom:0">Admin panel</h2><button class="btn btn-sm btn-red" onclick="logoutAdmin()">Odhl√°sit</button></div>
      <div class="admin-tabs" id="admin-tabs">
        <button class="admin-tab active" onclick="showAdminTab('schedule')">Program</button>
        <button class="admin-tab" onclick="showAdminTab('activities')">Aktivity</button>
        <button class="admin-tab" onclick="showAdminTab('educators')">Vychovatelky</button>
        <button class="admin-tab" onclick="showAdminTab('children')">Dƒõti</button>
        <button class="admin-tab" onclick="showAdminTab('stats')">Statistiky</button>
        <button class="admin-tab" onclick="showAdminTab('settings')">Nastaven√≠</button>
      </div>
    </div>
    <div id="admin-tab-schedule" class="admin-tab-content active"></div>
    <div id="admin-tab-activities" class="admin-tab-content"></div>
    <div id="admin-tab-educators" class="admin-tab-content"></div>
    <div id="admin-tab-children" class="admin-tab-content"></div>
    <div id="admin-tab-stats" class="admin-tab-content"></div>
    <div id="admin-tab-settings" class="admin-tab-content"></div>
  </div>
</div>

<nav class="bottom-nav" id="bottom-nav" style="display:none">
  <button class="nav-btn active" data-screen="dashboard" onclick="showScreen('dashboard')"><span class="nav-icon">üè†</span>P≈ôehled</button>
  <button class="nav-btn" data-screen="activities" onclick="showScreen('activities')"><span class="nav-icon">üèÉ</span>Aktivity</button>
  <button class="nav-btn" data-screen="km" onclick="showScreen('km')"><span class="nav-icon">üö∂</span>Kilometry</button>
  <button class="nav-btn" data-screen="leaderboard" onclick="showScreen('leaderboard')"><span class="nav-icon">üèÜ</span>≈Ωeb≈ô√≠ƒçek</button>
  <button class="nav-btn" data-screen="profiles" onclick="showScreen('profiles')"><span class="nav-icon">üë•</span>Dƒõti</button>
  <button class="nav-btn" data-screen="auth" onclick="logoutChild()"><span class="nav-icon">üö™</span>Odhl√°sit</button>
</nav>
<div class="toast" id="toast"></div>
<div class="modal-overlay" id="modal-overlay"><div class="modal" id="modal-content"></div></div>
<script>
// ============ SUPABASE ============
const SUPABASE_URL = 'https://fapcodsdlanixidmqaiy.supabase.co';
const SUPABASE_KEY = 'sb_publishable_qs3liD4kaOecwWIbpAY6Tw_dD10VaC5';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let _cache = null;
let _syncing = false;

// ============ DATA MODEL ============
const DEFAULT_DATA = {
  children: [],
  educators: [],
  activities: [],
  locations: [
    { id: "telocvicna", name: "Tƒõlocviƒçna", icon: "üèãÔ∏è" },
    { id: "hriste", name: "H≈ôi≈°tƒõ", icon: "‚öΩ" },
    { id: "hala", name: "Hala", icon: "üèüÔ∏è" },
    { id: "bazen", name: "Baz√©n", icon: "üèä" },
    { id: "park", name: "Park", icon: "üå≥" },
    { id: "okoli", name: "Okol√≠", icon: "üèûÔ∏è" }
  ],
  schedule: {},
  settings: {
    adminPassword: "kretin2026",
    kmCutoffHour: 21,
    cancelBeforeStartMinutes: 30,
    groups: ["Hvƒõzdiƒçky", "Slun√≠ƒçka"],
    subgroups: ["≈Ωraloci", "Kosatky", "Krokod√Ωli"],
    programStart: "2026-03-03",
    programEnd: "2026-03-31"
  }
};

function migrateData(d) {
  if (!d) return JSON.parse(JSON.stringify(DEFAULT_DATA));
  if (!d.locations) d.locations = DEFAULT_DATA.locations;
  if (!d.schedule) d.schedule = {};
  if (!d.educators) d.educators = [];
  if (!d.children) d.children = [];
  if (!d.settings) d.settings = JSON.parse(JSON.stringify(DEFAULT_DATA.settings));
  if (!d.settings.groups) d.settings.groups = DEFAULT_DATA.settings.groups;
  if (!d.settings.subgroups) d.settings.subgroups = DEFAULT_DATA.settings.subgroups;

  // Migrate: educator.activities[] ‚Üí global activities[] + educator.activityIds[]
  if (!d.activities) {
    d.activities = [];
    const seen = {};
    d.educators.forEach(edu => {
      if (edu.activities && Array.isArray(edu.activities)) {
        const ids = [];
        edu.activities.forEach(act => {
          if (!seen[act.name]) {
            const id = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
            d.activities.push({ id: id, name: act.name, points: act.points, icon: act.icon || 'üèÉ', locationId: act.locationId || '', maxKids: act.maxKids || 8 });
            seen[act.name] = id;
          }
          ids.push(seen[act.name]);
        });
        edu.activityIds = ids;
        delete edu.activities;
      }
    });
    // Migrate schedule slots: activityName ‚Üí activityId
    for (const date in d.schedule) {
      if (d.schedule[date] && d.schedule[date].slots) {
        d.schedule[date].slots.forEach(slot => {
          if (slot.activityName && !slot.activityId) {
            slot.activityId = seen[slot.activityName] || '';
            delete slot.activityName;
          }
        });
      }
    }
    // Migrate child records: add activityId
    d.children.forEach(child => {
      if (!child.records) return;
      for (const day in child.records) {
        const r = child.records[day];
        if (r.activity && r.activity.name && !r.activity.activityId) {
          r.activity.activityId = seen[r.activity.name] || '';
        }
      }
    });
  }
  // Ensure all educators use activityIds format
  d.educators.forEach(edu => {
    if (!edu.activityIds) {
      edu.activityIds = [];
      delete edu.activities;
    }
  });

  if (!d.settings.cancelBeforeStartMinutes) d.settings.cancelBeforeStartMinutes = 30;
  if (d.settings.cancelWindowMinutes) delete d.settings.cancelWindowMinutes;
  if (!d.settings.programStart) d.settings.programStart = "2026-03-03";
  if (!d.settings.programEnd) d.settings.programEnd = "2026-03-31";

  return d;
}

function loadData() {
  if (_cache) return _cache;
  try {
    const d = JSON.parse(localStorage.getItem('kretin_v2'));
    _cache = migrateData(d);
    return _cache;
  } catch { return JSON.parse(JSON.stringify(DEFAULT_DATA)); }
}

function saveData(data) {
  _cache = data;
  localStorage.setItem('kretin_v2', JSON.stringify(data));
  pushToSupabase(data);
}

async function pushToSupabase(data) {
  if (_syncing) return;
  _syncing = true;
  try {
    await sb.from('app_state').upsert({ id: 1, data: data, updated_at: new Date().toISOString() });
  } catch (e) { console.error('Supabase push:', e); }
  _syncing = false;
}

async function syncFromSupabase() {
  try {
    const { data: row, error } = await sb.from('app_state').select('data').eq('id', 1).single();
    if (error) throw error;
    if (row && row.data && (row.data.children || row.data.settings)) {
      const d = migrateData(row.data);
      _cache = d;
      localStorage.setItem('kretin_v2', JSON.stringify(d));
      return true;
    }
  } catch (e) { console.error('Supabase sync:', e); }
  return false;
}

function refreshCurrentScreen() {
  const active = document.querySelector('.screen.active');
  if (!active) return;
  const id = active.id.replace('screen-', '');
  if (id === 'dashboard') renderDashboard();
  else if (id === 'activities') renderActivities();
  else if (id === 'km') renderKm();
  else if (id === 'leaderboard') renderLeaderboard();
  else if (id === 'profiles') renderProfiles();
  else if (id === 'admin') renderAdmin();
}

function getToday() { return new Date().toISOString().slice(0, 10); }
function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 6); }
function formatDate(d) { const p = d.split('-'); return p[2] + '.' + p[1] + '.' + p[0]; }
function formatDateShort(d) { const p = d.split('-'); return p[2] + '.' + p[1] + '.'; }

function getDaysBetween(startStr, endStr) {
  const days = [];
  const s = new Date(startStr + 'T00:00:00');
  const e = new Date(endStr + 'T00:00:00');
  for (let d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    days.push(y + '-' + m + '-' + day);
  }
  return days;
}

function getDayAbbr(dateStr) {
  const abbrs = ['Ne','Po','√öt','St','ƒåt','P√°','So'];
  return abbrs[new Date(dateStr + 'T00:00:00').getDay()];
}

function getDaySummary(data, dateStr) {
  const sched = data.schedule[dateStr];
  const activityCount = sched && sched.slots ? sched.slots.length : 0;
  const educatorCount = sched && sched.checkedEducators ? sched.checkedEducators.length : 0;
  const hasSchedule = activityCount > 0 || educatorCount > 0;
  return { activityCount, educatorCount, hasSchedule };
}

function getRecord(child, date) {
  if (!child.records) child.records = {};
  if (!child.records[date]) child.records[date] = { activity: null, km: 0 };
  const rec = child.records[date];
  if (rec.activities && !rec.activity) {
    if (rec.activities.length > 0) rec.activity = rec.activities[0];
    delete rec.activities;
  }
  return rec;
}

function getTodayRecord(child) {
  return getRecord(child, getToday());
}

function getTotalPoints(child) {
  if (!child.records) return 0;
  let total = 0;
  for (const day in child.records) {
    const r = child.records[day];
    if (r.activity) total += r.activity.points;
    if (r.activities) r.activities.forEach(a => { total += a.points; });
    if (r.km) total += r.km;
  }
  return total;
}

function getActivitySignups(data, date, activityId) {
  return data.children.filter(c => {
    const rec = c.records && c.records[date];
    return rec && rec.activity && rec.activity.activityId === activityId;
  }).length;
}

function getLocationName(data, locId) {
  const loc = data.locations.find(l => l.id === locId);
  return loc ? loc.name : locId;
}

function getLocationIcon(data, locId) {
  const loc = data.locations.find(l => l.id === locId);
  return loc ? loc.icon : 'üìç';
}

function getEducatorName(data, eduId) {
  const edu = data.educators.find(e => e.id === eduId);
  return edu ? edu.name : '?';
}

function getActivity(data, actId) {
  return data.activities.find(a => a.id === actId);
}

function parseTimeSlotStart(timeSlot) {
  if (!timeSlot) return null;
  const m = timeSlot.match(/^(\d{1,2}):(\d{2})/);
  if (!m) return null;
  return { hours: parseInt(m[1]), minutes: parseInt(m[2]) };
}

// ============ STATE ============
let currentChildId = null;
let isAdmin = false;
let currentFilter = 'all';
let currentSubFilter = 'all';
let selectedLoginId = null;
let regPhotoData = null;
let currentAdminTab = 'schedule';
let scheduleDate = getToday();
let activityDate = getToday();
let scheduleDayVariant = 'grid';

// ============ NAVIGATION ============
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const nb = document.querySelector('.nav-btn[data-screen="' + name + '"]');
  if (nb) nb.classList.add('active');
  if (name === 'dashboard') renderDashboard();
  if (name === 'activities') renderActivities();
  if (name === 'km') renderKm();
  if (name === 'leaderboard') renderLeaderboard();
  if (name === 'profiles') renderProfiles();
  if (name === 'admin') renderAdmin();
}

function showNav(show) { document.getElementById('bottom-nav').style.display = show ? 'flex' : 'none'; }

function showAdminTab(tab) {
  currentAdminTab = tab;
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.admin-tab-content').forEach(t => t.classList.remove('active'));
  const tabs = document.querySelectorAll('.admin-tab');
  const idx = ['schedule','activities','educators','children','stats','settings'].indexOf(tab);
  if (idx >= 0 && tabs[idx]) tabs[idx].classList.add('active');
  document.getElementById('admin-tab-' + tab).classList.add('active');
  renderAdmin();
}

// ============ TOAST & MODAL ============
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

function openModal() { document.getElementById('modal-overlay').classList.add('open'); }
function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); }

// ============ UTILS ============
function esc(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }

function selectOption(el) {
  el.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

function getSelectedOption(groupId) {
  const sel = document.querySelector('#' + groupId + ' .option-btn.selected');
  return sel ? sel.dataset.val : null;
}

// ============ AUTH ============
function renderGroupOptions() {
  const data = loadData();
  const groupEl = document.getElementById('reg-group');
  const subEl = document.getElementById('reg-subgroup');
  if (groupEl) groupEl.innerHTML = data.settings.groups.map(g =>
    '<div class="option-btn" data-val="' + esc(g) + '" onclick="selectOption(this)">' + esc(g) + '</div>'
  ).join('');
  if (subEl) subEl.innerHTML = data.settings.subgroups.map(s =>
    '<div class="option-btn" data-val="' + esc(s) + '" onclick="selectOption(this)">' + esc(s) + '</div>'
  ).join('');
}

function showRegister() {
  document.getElementById('register-form').style.display = 'block';
  document.getElementById('login-form').style.display = 'none';
  document.getElementById('admin-login').style.display = 'none';
  renderGroupOptions();
}
function hideRegister() { document.getElementById('register-form').style.display = 'none'; }
function showLogin() {
  document.getElementById('login-form').style.display = 'block';
  document.getElementById('register-form').style.display = 'none';
  document.getElementById('admin-login').style.display = 'none';
  renderLoginList();
}
function hideLogin() { document.getElementById('login-form').style.display = 'none'; selectedLoginId = null; }
function showAdminLogin() {
  document.getElementById('admin-login').style.display = 'block';
  document.getElementById('register-form').style.display = 'none';
  document.getElementById('login-form').style.display = 'none';
}
function hideAdminLogin() { document.getElementById('admin-login').style.display = 'none'; }

function previewPhoto(input) {
  if (!input.files || !input.files[0]) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    regPhotoData = e.target.result;
    document.getElementById('reg-avatar-preview').innerHTML = '<img src="' + regPhotoData + '" alt="foto">';
  };
  reader.readAsDataURL(input.files[0]);
}

function registerChild() {
  const name = document.getElementById('reg-name').value.trim();
  const gender = getSelectedOption('reg-gender');
  const age = parseInt(document.getElementById('reg-age').value);
  const group = getSelectedOption('reg-group');
  const subgroup = getSelectedOption('reg-subgroup');
  const pin = document.getElementById('reg-pin').value.trim();
  if (!name) { toast('Vypl≈à jm√©no!'); return; }
  if (!gender) { toast('Vyber pohlav√≠!'); return; }
  if (!age || age < 4 || age > 18) { toast('Vypl≈à vƒõk (4‚Äì18)!'); return; }
  if (!group) { toast('Vyber skupinu!'); return; }
  if (!subgroup) { toast('Vyber podskupinu!'); return; }
  if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) { toast('PIN mus√≠ b√Ωt 4 ƒç√≠slice!'); return; }
  const data = loadData();
  const id = genId();
  data.children.push({ id, name, gender, age, group, subgroup, pin, photo: regPhotoData || null, records: {} });
  saveData(data);
  regPhotoData = null;
  document.getElementById('reg-name').value = '';
  document.getElementById('reg-age').value = '';
  document.getElementById('reg-pin').value = '';
  document.getElementById('reg-photo').value = '';
  document.getElementById('reg-avatar-preview').innerHTML = 'üì∑';
  document.querySelectorAll('#register-form .option-btn').forEach(b => b.classList.remove('selected'));
  currentChildId = id;
  hideRegister();
  showNav(true);
  showScreen('dashboard');
  toast('Registrace √∫spƒõ≈°n√°!');
}

function renderLoginList() {
  const data = loadData();
  const list = document.getElementById('login-list');
  document.getElementById('login-pin-wrap').style.display = 'none';
  selectedLoginId = null;
  if (data.children.length === 0) {
    list.innerHTML = '<li class="empty-state"><div class="empty-icon">ü§∑</div><p>Zat√≠m nikdo nen√≠ registrovan√Ω.</p></li>';
    return;
  }
  list.innerHTML = data.children.map(c => '<li class="child-list-item" onclick="selectLoginChild(\'' + c.id + '\',this)"><div class="avatar">' + (c.photo ? '<img src="' + c.photo + '" alt="">' : (c.gender === 'kluk' ? 'üßí' : 'üëß')) + '</div><div class="cl-info">' + esc(c.name) + '<small>' + esc(c.group) + ' ¬∑ ' + esc(c.subgroup) + ' ¬∑ ' + c.age + ' let</small></div></li>').join('');
}

function selectLoginChild(id, el) {
  selectedLoginId = id;
  document.querySelectorAll('.child-list-item').forEach(i => i.style.background = '');
  el.style.background = '#E3F2FD';
  document.getElementById('login-pin-wrap').style.display = 'block';
  document.getElementById('login-pin').value = '';
  document.getElementById('login-pin').focus();
}

function loginChild() {
  if (!selectedLoginId) { toast('Vyber se ze seznamu!'); return; }
  const pin = document.getElementById('login-pin').value.trim();
  const data = loadData();
  const child = data.children.find(c => c.id === selectedLoginId);
  if (!child) { toast('D√≠tƒõ nenalezeno!'); return; }
  if (child.pin !== pin) { toast('≈†patn√Ω PIN!'); return; }
  currentChildId = child.id;
  hideLogin();
  showNav(true);
  showScreen('dashboard');
  toast('Ahoj, ' + child.name + '!');
}

function logoutChild() { currentChildId = null; isAdmin = false; showNav(false); showScreen('auth'); }

async function hashPassword(plain) {
  const data = new TextEncoder().encode(plain);
  const buf = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

function isHashed(val) { return typeof val === 'string' && val.length === 64 && /^[a-f0-9]+$/.test(val); }

async function loginAdmin() {
  const data = loadData();
  const pass = document.getElementById('admin-pass').value;
  const hashed = await hashPassword(pass);
  if (hashed !== data.settings.adminPassword) { toast('≈†patn√© heslo!'); return; }
  isAdmin = true;
  hideAdminLogin();
  showNav(false);
  document.querySelector('.app-container').classList.add('admin-wide');
  showScreen('admin');
  toast('Admin p≈ôihl√°≈°en');
}

function logoutAdmin() { isAdmin = false; document.querySelector('.app-container').classList.remove('admin-wide'); showScreen('auth'); }

// ============ DASHBOARD ============
function renderDashboard() {
  const data = loadData();
  const child = data.children.find(c => c.id === currentChildId);
  if (!child) return;
  document.getElementById('dash-avatar').innerHTML = child.photo ? '<img src="' + child.photo + '" alt="">' : (child.gender === 'kluk' ? 'üßí' : 'üëß');
  document.getElementById('dash-name').textContent = child.name;
  document.getElementById('dash-group').textContent = child.group + ' ¬∑ ' + child.subgroup + ' ¬∑ ' + child.age + ' let';
  document.getElementById('dash-points').textContent = getTotalPoints(child);
  const today = getToday();
  document.getElementById('dash-date').textContent = formatDate(today);
  const active = isProgramActive(data);
  const warnEl = document.getElementById('dash-program-warning');
  const quickEl = document.getElementById('dash-quick-actions');
  if (!active) {
    const msg = today < data.settings.programStart
      ? 'Program zaƒç√≠n√° ' + formatDate(data.settings.programStart)
      : 'Program skonƒçil ' + formatDate(data.settings.programEnd);
    warnEl.innerHTML = msg;
    warnEl.style.display = 'block';
    quickEl.style.display = 'none';
  } else {
    warnEl.style.display = 'none';
    quickEl.style.display = '';
  }
  const rec = getTodayRecord(child);
  const list = document.getElementById('dash-today-list');
  const empty = document.getElementById('dash-today-empty');
  const items = [];
  if (rec.activity) {
    const canRemove = active && isCancellable(rec.activity, data, today);
    const removeBtn = canRemove
      ? '<button class="remove-btn" onclick="removeTodayActivity()" title="Odebrat">‚úï</button>'
      : '<span style="font-size:.7rem;color:var(--gray)">üîí</span>';
    items.push('<li><span>' + (rec.activity.icon || 'üèÉ') + ' ' + esc(rec.activity.name) + ' <strong>(+' + rec.activity.points + 'b)</strong></span>' + removeBtn + '</li>');
  }
  if (rec.km > 0) {
    const kmBtn = (!active || isKmLocked(data)) ? '<span style="font-size:.7rem;color:var(--gray)">üîí</span>' : '<button class="remove-btn" onclick="resetTodayKm()">‚úï</button>';
    items.push('<li><span>üö∂ ' + rec.km + ' km <strong>(+' + rec.km + 'b)</strong></span>' + kmBtn + '</li>');
  }
  if (items.length === 0) { list.innerHTML = ''; empty.style.display = 'block'; }
  else { list.innerHTML = items.join(''); empty.style.display = 'none'; }

  // Schedule preview ‚Äî show all scheduled dates
  const scheduledDates = getScheduledDates(data);
  const preview = document.getElementById('dash-schedule-preview');
  if (scheduledDates.length === 0) {
    preview.innerHTML = '<div class="empty-state"><p>Nejsou napl√°nov√°ny ≈æ√°dn√© aktivity.</p></div>';
  } else {
    let schedHtml = '';
    scheduledDates.forEach(date => {
      const sched = data.schedule[date];
      const isToday = date === today;
      const dateLabel = isToday ? 'üìÖ Dnes (' + formatDateShort(date) + ')' : 'üìÖ ' + formatDateShort(date);
      const childRec = getRecord(child, date);
      const hasDone = childRec.activity;
      schedHtml += '<div style="margin-bottom:12px">';
      schedHtml += '<div style="font-weight:700;font-size:.9rem;margin-bottom:6px;color:' + (isToday ? 'var(--blue)' : '#555') + '">' + dateLabel;
      if (sched.timeSlot) schedHtml += ' <span style="font-weight:400;font-size:.8rem;color:var(--gray)">‚è∞ ' + esc(sched.timeSlot) + '</span>';
      if (hasDone) schedHtml += ' <span style="color:var(--green)">‚úì</span>';
      schedHtml += '</div>';
      schedHtml += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
      sched.slots.forEach(s => {
        const act = getActivity(data, s.activityId);
        const actName = act ? act.name : '?';
        const signups = getActivitySignups(data, date, s.activityId);
        const locIcon = getLocationIcon(data, s.locationId);
        schedHtml += '<div style="padding:10px;border-radius:var(--radius-sm);background:var(--gray-light);text-align:center;font-size:.8rem"><span style="font-size:1.4rem;display:block">' + (s.icon || 'üèÉ') + '</span><strong>' + esc(actName) + '</strong><br><span style="color:var(--gray);font-size:.7rem">' + locIcon + ' ' + getLocationName(data, s.locationId) + '</span><br><span style="font-size:.7rem;font-weight:700;color:' + (signups >= s.maxKids ? 'var(--red)' : 'var(--green)') + '">' + signups + '/' + s.maxKids + '</span></div>';
      });
      schedHtml += '</div></div>';
    });
    preview.innerHTML = schedHtml;
  }
}

function removeTodayActivity() {
  const data = loadData();
  const child = data.children.find(c => c.id === currentChildId);
  if (!child) return;
  const rec = getTodayRecord(child);
  if (!rec.activity) return;
  if (!isCancellable(rec.activity, data, getToday())) { toast('ƒåas na zmƒõnu vypr≈°el'); return; }
  const name = rec.activity.name;
  rec.activity = null;
  saveData(data);
  renderDashboard();
  toast('Odebr√°no: ' + name);
}

function resetTodayKm() {
  const data = loadData();
  if (isKmLocked(data)) { toast('Z√°znam km je uzav≈ôen'); return; }
  const child = data.children.find(c => c.id === currentChildId);
  if (!child) return;
  const rec = getTodayRecord(child);
  rec.km = 0;
  saveData(data);
  renderDashboard();
  toast('Kilometry resetov√°ny');
}

// ============ ACTIVITIES ============
function getScheduledDates(data) {
  const dates = Object.keys(data.schedule).filter(d => {
    const s = data.schedule[d];
    return s && s.slots && s.slots.length > 0;
  }).sort();
  return dates;
}

function isCancellable(activity, data, date) {
  if (!activity) return false;
  const sched = date && data.schedule[date];
  const ts = sched && sched.timeSlot ? parseTimeSlotStart(sched.timeSlot) : null;
  if (!ts) return true; // no schedule/timeSlot ‚Üí always cancellable
  const beforeMin = data.settings.cancelBeforeStartMinutes || 30;
  const startTime = new Date(date + 'T00:00:00');
  startTime.setHours(ts.hours, ts.minutes, 0, 0);
  const deadline = startTime.getTime() - beforeMin * 60000;
  return Date.now() < deadline;
}

function getCancelMinutesLeft(activity, data, date) {
  if (!activity) return 0;
  const sched = date && data.schedule[date];
  const ts = sched && sched.timeSlot ? parseTimeSlotStart(sched.timeSlot) : null;
  if (!ts) return 999;
  const beforeMin = data.settings.cancelBeforeStartMinutes || 30;
  const startTime = new Date(date + 'T00:00:00');
  startTime.setHours(ts.hours, ts.minutes, 0, 0);
  const deadline = startTime.getTime() - beforeMin * 60000;
  return Math.max(0, Math.ceil((deadline - Date.now()) / 60000));
}

function renderActivities() {
  const data = loadData();
  const child = data.children.find(c => c.id === currentChildId);
  if (!child) return;
  const today = getToday();
  const scheduledDates = getScheduledDates(data);
  const infoEl = document.getElementById('activity-info');
  const container = document.getElementById('activity-slots-container');

  if (!isProgramActive(data)) {
    const td = getToday();
    const msg = td < data.settings.programStart
      ? 'Program zaƒç√≠n√° ' + formatDate(data.settings.programStart)
      : 'Program skonƒçil ' + formatDate(data.settings.programEnd);
    infoEl.innerHTML = '<div class="warning-box">' + msg + '<br><small style="font-weight:400">Z√°znam aktivit je dostupn√Ω jen bƒõhem programu.</small></div>';
    container.innerHTML = '';
    return;
  }

  // If no scheduled dates at all
  if (scheduledDates.length === 0) {
    infoEl.innerHTML = '';
    container.innerHTML = '<div class="card"><div class="empty-state"><div class="empty-icon">üìã</div><p>Nejsou napl√°nov√°ny ≈æ√°dn√© aktivity.</p></div></div>';
    return;
  }

  // Make sure activityDate is a valid scheduled date
  if (!scheduledDates.includes(activityDate)) {
    // Try today first, then nearest future, then first available
    if (scheduledDates.includes(today)) activityDate = today;
    else {
      const future = scheduledDates.find(d => d >= today);
      activityDate = future || scheduledDates[scheduledDates.length - 1];
    }
  }

  const selDate = activityDate;
  const rec = getRecord(child, selDate);
  const dateActivity = rec.activity;
  const canCancel = dateActivity && isCancellable(dateActivity, data, selDate);
  const sched = data.schedule[selDate];
  const isToday = selDate === today;

  // Date selector tabs
  let dateTabsHtml = '<div class="filter-bar" style="margin-bottom:12px">';
  scheduledDates.forEach(d => {
    const isActive = d === selDate;
    const label = d === today ? 'Dnes ' + formatDateShort(d) : formatDateShort(d);
    const dayRec = getRecord(child, d);
    const hasDone = dayRec.activity ? ' ‚úì' : '';
    dateTabsHtml += '<button class="filter-btn' + (isActive ? ' active' : '') + '" onclick="activityDate=\'' + d + '\';renderActivities()">' + label + hasDone + '</button>';
  });
  dateTabsHtml += '</div>';

  // Info box for selected date
  let infoHtml = dateTabsHtml;
  if (dateActivity) {
    if (canCancel) {
      const mins = getCancelMinutesLeft(dateActivity, data, selDate);
      infoHtml += '<div class="success-box">‚úÖ Aktivita na ' + formatDateShort(selDate) + ': <strong>' + esc(dateActivity.name) + '</strong> (+' + dateActivity.points + 'b)<br><small style="font-weight:400">M≈Ø≈æe≈° zmƒõnit do ' + mins + ' min p≈ôed zaƒç√°tkem ‚Äî klikni na aktivitu pro zru≈°en√≠</small></div>';
    } else {
      infoHtml += '<div class="success-box">‚úÖ Aktivita na ' + formatDateShort(selDate) + ': <strong>' + esc(dateActivity.name) + '</strong> (+' + dateActivity.points + 'b)<br><small style="font-weight:400;color:var(--gray)">Aktivita je uzamƒçena</small></div>';
    }
  } else {
    infoHtml += '<div class="info-box">Vyber si jednu aktivitu na ' + formatDate(selDate) + ':</div>';
  }
  infoEl.innerHTML = infoHtml;

  if (!sched || !sched.slots || sched.slots.length === 0) {
    container.innerHTML = '<div class="card"><div class="empty-state"><div class="empty-icon">üìã</div><p>Na tento den nejsou napl√°nov√°ny aktivity.</p></div></div>';
    return;
  }

  let html = '';
  if (sched.timeSlot) {
    html += '<p style="text-align:center;font-size:.85rem;color:var(--gray);margin-bottom:12px">‚è∞ ' + esc(sched.timeSlot) + '</p>';
  }
  html += '<div class="activity-grid">';
  sched.slots.forEach(slot => {
    const act = getActivity(data, slot.activityId);
    const actName = act ? act.name : '?';
    const signups = getActivitySignups(data, selDate, slot.activityId);
    const isFull = signups >= slot.maxKids;
    const isThis = dateActivity && dateActivity.activityId === slot.activityId;
    const ptsClass = slot.points <= 10 ? 'pts-10' : slot.points <= 20 ? 'pts-20' : 'pts-30';
    let cls = 'activity-tile ' + ptsClass;
    let onclick = '';
    if (isThis) {
      cls += ' done';
      if (canCancel) { cls += ' cancellable'; onclick = 'onclick="cancelActivity()"'; }
    } else if (dateActivity) {
      cls += ' locked';
    } else if (isFull) {
      cls += ' locked';
    } else {
      onclick = 'onclick="addActivity(\'' + slot.activityId + '\')"';
    }
    const locIcon = getLocationIcon(data, slot.locationId);
    const eduName = getEducatorName(data, slot.educatorId);
    html += '<div class="' + cls + '" ' + onclick + '>';
    html += '<span class="tile-icon">' + (slot.icon || 'üèÉ') + '</span>';
    html += esc(actName);
    html += '<div class="tile-meta">' + locIcon + ' ' + getLocationName(data, slot.locationId) + ' ¬∑ ' + esc(eduName) + '</div>';
    html += '<div class="tile-capacity ' + (isFull ? 'full' : '') + '">' + signups + '/' + slot.maxKids + '</div>';
    html += '<div style="font-size:.75rem;font-weight:800;margin-top:2px">+' + slot.points + 'b</div>';
    html += '</div>';
  });
  html += '</div>';
  container.innerHTML = '<div class="card">' + html + '</div>';
}

function addActivity(activityId) {
  const data = loadData();
  const child = data.children.find(c => c.id === currentChildId);
  if (!child) return;
  const act = getActivity(data, activityId);
  if (!act) return;
  const selDate = activityDate;
  const rec = getRecord(child, selDate);
  if (rec.activity) { toast('Na tento den u≈æ m√°≈° zvolenou aktivitu!'); return; }
  const sched = data.schedule[selDate];
  if (sched) {
    const slot = sched.slots.find(s => s.activityId === activityId);
    if (slot) {
      const signups = getActivitySignups(data, selDate, activityId);
      if (signups >= slot.maxKids) { toast('Aktivita je pln√°!'); return; }
    }
  }
  rec.activity = { activityId: act.id, name: act.name, points: act.points, icon: act.icon, timestamp: Date.now() };
  saveData(data);
  renderActivities();
  toast('+' + act.points + 'b za ' + act.name + '!');
}

function cancelActivity() {
  const data = loadData();
  const child = data.children.find(c => c.id === currentChildId);
  if (!child) return;
  const rec = getRecord(child, activityDate);
  if (!rec.activity) return;
  if (!isCancellable(rec.activity, data, activityDate)) { toast('ƒåas na zmƒõnu vypr≈°el'); return; }
  const name = rec.activity.name;
  rec.activity = null;
  saveData(data);
  renderActivities();
  toast('Zru≈°eno: ' + name + ' ‚Äî vyber jinou');
}

// ============ KILOMETERS ============
function isKmLocked(data) {
  return new Date().getHours() >= (data.settings.kmCutoffHour || 21);
}

function isProgramActive(data) {
  const today = getToday();
  return today >= data.settings.programStart && today <= data.settings.programEnd;
}

function renderKm() {
  const data = loadData();
  const child = data.children.find(c => c.id === currentChildId);
  if (!child) return;
  if (!isProgramActive(data)) {
    const today = getToday();
    const msg = today < data.settings.programStart
      ? 'Program zaƒç√≠n√° ' + formatDate(data.settings.programStart)
      : 'Program skonƒçil ' + formatDate(data.settings.programEnd);
    document.getElementById('km-lock-msg').style.display = 'block';
    document.getElementById('km-lock-msg').innerHTML = msg + '<br><small style="font-weight:400">Z√°znam kilometr≈Ø je dostupn√Ω jen bƒõhem programu.</small>';
    document.getElementById('km-controls').style.display = 'none';
    document.getElementById('km-slider').disabled = true;
    return;
  }
  const rec = getTodayRecord(child);
  const locked = isKmLocked(data);
  document.getElementById('km-today-saved').textContent = rec.km || 0;
  document.getElementById('km-slider').value = rec.km || 0;
  document.getElementById('km-value').textContent = rec.km || 0;
  document.getElementById('km-slider').disabled = locked;
  document.getElementById('km-lock-msg').style.display = locked ? 'block' : 'none';
  document.getElementById('km-lock-msg').innerHTML = 'Z√°znam kilometr≈Ø je uzav≈ôen.<br><small style="font-weight:400">Kilometry lze zapisovat ka≈æd√Ω den do stanoven√© hodiny.</small>';
  document.getElementById('km-controls').style.display = locked ? 'none' : 'block';
}

function updateKmDisplay(val) { document.getElementById('km-value').textContent = val; }

function adjustKm(delta) {
  const data = loadData();
  if (isKmLocked(data)) { toast('Z√°znam km je uzav≈ôen'); return; }
  const slider = document.getElementById('km-slider');
  let val = Math.max(0, Math.min(20, Math.round((parseFloat(slider.value) + delta) * 2) / 2));
  slider.value = val;
  updateKmDisplay(val);
}

function saveKm() {
  const data = loadData();
  if (isKmLocked(data)) { toast('Z√°znam km je uzav≈ôen'); return; }
  const child = data.children.find(c => c.id === currentChildId);
  if (!child) return;
  const rec = getTodayRecord(child);
  const val = parseFloat(document.getElementById('km-slider').value);
  rec.km = val;
  saveData(data);
  document.getElementById('km-today-saved').textContent = val;
  toast('Ulo≈æeno: ' + val + ' km (+' + val + 'b)');
}

// ============ LEADERBOARD ============
function renderLeaderboardFilters() {
  const data = loadData();
  const fBar = document.getElementById('leaderboard-filters');
  let html = '<button class="filter-btn ' + (currentFilter === 'all' ? 'active' : '') + '" onclick="setFilter(\'all\',this)">V≈°ichni</button>';
  html += '<button class="filter-btn ' + (currentFilter === 'kluk' ? 'active' : '') + '" onclick="setFilter(\'kluk\',this)">Kluci</button>';
  html += '<button class="filter-btn ' + (currentFilter === 'holka' ? 'active' : '') + '" onclick="setFilter(\'holka\',this)">Holky</button>';
  data.settings.groups.forEach(g => {
    html += '<button class="filter-btn ' + (currentFilter === g ? 'active' : '') + '" onclick="setFilter(\'' + esc(g) + '\',this)">' + esc(g) + '</button>';
  });
  fBar.innerHTML = html;

  const sBar = document.getElementById('subgroup-filters');
  let shtml = '<button class="filter-btn ' + (currentSubFilter === 'all' ? 'active' : '') + '" onclick="setSubFilter(\'all\',this)">V≈°echny</button>';
  data.settings.subgroups.forEach(s => {
    shtml += '<button class="filter-btn ' + (currentSubFilter === s ? 'active' : '') + '" onclick="setSubFilter(\'' + esc(s) + '\',this)">' + esc(s) + '</button>';
  });
  sBar.innerHTML = shtml;
}

function setFilter(f) { currentFilter = f; renderLeaderboard(); }
function setSubFilter(f) { currentSubFilter = f; renderLeaderboard(); }

function renderLeaderboard() {
  const data = loadData();
  renderLeaderboardFilters();
  renderGroupCompare(data);
  renderSubgroupCompare(data);

  let children = [...data.children];
  if (currentFilter === 'kluk' || currentFilter === 'holka') children = children.filter(c => c.gender === currentFilter);
  else if (currentFilter !== 'all') children = children.filter(c => c.group === currentFilter);
  if (currentSubFilter !== 'all') children = children.filter(c => c.subgroup === currentSubFilter);
  children.sort((a, b) => getTotalPoints(b) - getTotalPoints(a));

  const container = document.getElementById('leaderboard-chart');
  if (children.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üèÜ</div><p>≈Ω√°dn√≠ √∫ƒçastn√≠ci.</p></div>';
    return;
  }
  const maxPts = Math.max(1, getTotalPoints(children[0]));
  container.innerHTML = '<div class="lb-chart">' + children.map((c, i) => {
    const rank = i + 1;
    const pts = getTotalPoints(c);
    const barH = Math.max(30, Math.round((pts / maxPts) * 150));
    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
    const barCls = rank <= 3 ? 'bar-' + rank : 'bar-rest';
    const av = c.photo ? '<img src="' + c.photo + '" alt="">' : (c.gender === 'kluk' ? 'üßí' : 'üëß');
    return '<div class="lb-bar"><div class="lb-bar-top"><div class="avatar">' + av + '</div><div class="lb-bar-name">' + esc(c.name) + '</div><div class="lb-bar-sub">' + esc(c.subgroup) + '</div></div><div class="lb-bar-col ' + barCls + '" style="height:' + barH + 'px">' + (medal ? '<span class="bar-rank">' + medal + '</span>' : '<span class="bar-rank" style="font-size:.7rem;color:rgba(255,255,255,.8)">' + rank + '.</span>') + '<span class="bar-pts">' + pts + 'b</span></div></div>';
  }).join('') + '</div>';
}

function renderGroupCompare(data) {
  const container = document.getElementById('group-compare');
  const colors = ['#FFF8E1', '#FFFDE7', '#E8F5E9', '#F3E5F5'];
  container.innerHTML = data.settings.groups.map((g, i) => {
    const members = data.children.filter(c => c.group === g);
    const total = members.reduce((s, c) => s + getTotalPoints(c), 0);
    const avg = members.length > 0 ? (total / members.length).toFixed(1) : 0;
    return '<div class="group-card" style="background:' + (colors[i % colors.length]) + '"><div class="group-name">' + esc(g) + '</div><div class="group-pts">' + total + 'b</div><div class="group-avg">' + members.length + ' dƒõt√≠ ¬∑ √ò ' + avg + 'b</div></div>';
  }).join('');
}

function renderSubgroupCompare(data) {
  const container = document.getElementById('subgroup-compare');
  const colors = ['#E3F2FD', '#E8F5E9', '#FFF3E0', '#F3E5F5'];
  container.style.gridTemplateColumns = 'repeat(' + Math.min(data.settings.subgroups.length, 3) + ',1fr)';
  container.innerHTML = data.settings.subgroups.map((s, i) => {
    const members = data.children.filter(c => c.subgroup === s);
    const total = members.reduce((sum, c) => sum + getTotalPoints(c), 0);
    const avg = members.length > 0 ? (total / members.length).toFixed(1) : 0;
    return '<div class="group-card" style="background:' + (colors[i % colors.length]) + '"><div class="group-name">' + esc(s) + '</div><div class="group-pts">' + total + 'b</div><div class="group-avg">' + members.length + ' dƒõt√≠ ¬∑ √ò ' + avg + 'b</div></div>';
  }).join('');
}

// ============ PROFILES ============
function renderProfiles() {
  const data = loadData();
  const grid = document.getElementById('profiles-grid');
  const detail = document.getElementById('profile-detail');
  detail.style.display = 'none';
  if (data.children.length === 0) {
    grid.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><p>Zat√≠m ≈æ√°dn√© dƒõti.</p></div>';
    return;
  }
  grid.innerHTML = data.children.map(c => {
    const pts = getTotalPoints(c);
    const av = c.photo ? '<img src="' + c.photo + '" alt="">' : (c.gender === 'kluk' ? 'üßí' : 'üëß');
    return '<div class="profile-icon" onclick="showProfileDetail(\'' + c.id + '\')"><div class="avatar">' + av + '</div><div class="profile-name">' + esc(c.name) + '</div><div class="profile-pts">‚≠ê ' + pts + 'b</div></div>';
  }).join('');
}

function showProfileDetail(id) {
  const data = loadData();
  const child = data.children.find(c => c.id === id);
  if (!child) return;
  const pts = getTotalPoints(child);
  const av = child.photo ? '<img src="' + child.photo + '" alt="">' : (child.gender === 'kluk' ? 'üßí' : 'üëß');
  const rankings = getRankings(child, data);
  let totalKm = 0;
  const days = Object.keys(child.records || {}).sort();
  days.forEach(d => { totalKm += (child.records[d].km || 0); });
  const activeDays = days.filter(d => { const r = child.records[d]; return (r.activity || (r.activities && r.activities.length > 0)) || r.km > 0; }).length;

  let daysHtml = '';
  if (days.length > 0) {
    daysHtml = [...days].reverse().map(day => {
      const r = child.records[day];
      const items = [];
      if (r.activity) {
        const cls = r.activity.points <= 10 ? 'tag-green' : r.activity.points <= 20 ? 'tag-orange' : 'tag-purple';
        items.push('<span class="tag ' + cls + '">' + (r.activity.icon || 'üèÉ') + ' ' + esc(r.activity.name) + ' +' + r.activity.points + 'b</span>');
      }
      if (r.activities) r.activities.forEach(a => {
        const cls = a.points <= 10 ? 'tag-green' : a.points <= 20 ? 'tag-orange' : 'tag-purple';
        items.push('<span class="tag ' + cls + '">' + (a.icon || 'üèÉ') + ' ' + esc(a.name) + ' +' + a.points + 'b</span>');
      });
      if (r.km > 0) items.push('<span class="tag tag-blue">üö∂ ' + r.km + ' km</span>');
      if (items.length === 0) return '';
      return '<div class="profile-day"><div class="profile-day-date">üìÖ ' + formatDate(day) + '</div><div class="profile-day-items">' + items.join('') + '</div></div>';
    }).filter(Boolean).join('');
  }
  if (!daysHtml) daysHtml = '<div class="empty-state"><div class="empty-icon">üìù</div><p>Zat√≠m ≈æ√°dn√© z√°znamy.</p></div>';

  const detail = document.getElementById('profile-detail');
  detail.style.display = 'block';
  detail.innerHTML = '<div class="card"><button class="btn btn-sm btn-outline mb-8" onclick="hideProfileDetail()">‚Üê Zpƒõt</button><div class="profile-detail-header"><div class="avatar">' + av + '</div><div class="pd-info"><h3>' + esc(child.name) + '</h3><p>' + esc(child.group) + ' ¬∑ ' + esc(child.subgroup) + ' ¬∑ ' + child.age + ' let</p></div></div><div class="profile-stats"><div class="profile-stat" style="background:#FFF8E1"><span class="stat-val" style="color:var(--orange)">‚≠ê ' + pts + '</span><span class="stat-label">Celkem bod≈Ø</span></div><div class="profile-stat" style="background:#E3F2FD"><span class="stat-val" style="color:var(--blue)">üö∂ ' + totalKm + '</span><span class="stat-label">Celkem km</span></div><div class="profile-stat" style="background:#E8F5E9"><span class="stat-val" style="color:var(--green)">üìÖ ' + activeDays + '</span><span class="stat-label">Aktivn√≠ch dn√≠</span></div></div><h3 class="mb-8">Um√≠stƒõn√≠</h3><div class="profile-stats" style="margin-bottom:14px"><div class="profile-stat"><span class="stat-val">' + rankings.overall.medal + ' ' + rankings.overall.rank + '.</span><span class="stat-label">Celkovƒõ (z ' + rankings.overall.total + ')</span></div><div class="profile-stat"><span class="stat-val">' + rankings.group.medal + ' ' + rankings.group.rank + '.</span><span class="stat-label">' + esc(child.group) + ' (z ' + rankings.group.total + ')</span></div><div class="profile-stat"><span class="stat-val">' + rankings.subgroup.medal + ' ' + rankings.subgroup.rank + '.</span><span class="stat-label">' + esc(child.subgroup) + ' (z ' + rankings.subgroup.total + ')</span></div></div><h3 class="mb-8">Denn√≠ z√°znamy</h3>' + daysHtml + '</div>';
  detail.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function getRankings(child, data) {
  function calcRank(list) {
    const sorted = list.map(c => ({ id: c.id, pts: getTotalPoints(c) })).sort((a, b) => b.pts - a.pts);
    const rank = sorted.findIndex(c => c.id === child.id) + 1;
    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : 'üèÖ';
    return { rank, total: sorted.length, medal };
  }
  return {
    overall: calcRank(data.children),
    group: calcRank(data.children.filter(c => c.group === child.group)),
    subgroup: calcRank(data.children.filter(c => c.subgroup === child.subgroup))
  };
}

function hideProfileDetail() {
  document.getElementById('profile-detail').style.display = 'none';
}

// ============ ADMIN ============
function renderAdmin() {
  if (currentAdminTab === 'schedule') renderAdminSchedule();
  else if (currentAdminTab === 'activities') renderAdminActivities();
  else if (currentAdminTab === 'educators') renderAdminEducators();
  else if (currentAdminTab === 'children') renderAdminChildren();
  else if (currentAdminTab === 'stats') renderAdminStats();
  else if (currentAdminTab === 'settings') renderAdminSettings();
}

// ---- SCHEDULE TAB ----
function renderAdminSchedule() {
  const data = loadData();
  const container = document.getElementById('admin-tab-schedule');
  const pStart = data.settings.programStart;
  const pEnd = data.settings.programEnd;
  const days = getDaysBetween(pStart, pEnd);
  const today = getToday();

  // Ensure scheduleDate is within range
  if (scheduleDate < pStart || scheduleDate > pEnd) scheduleDate = pStart;

  let html = '';

  // ---- Card 1: Program overview with day tiles ----
  html += '<div class="card">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h2 style="margin-bottom:0">Program</h2>';
  html += '<button class="btn btn-green btn-sm" onclick="exportScheduleExcel()">&#128202; Export rozvrhu</button></div>';

  // Date range inputs
  html += '<div class="program-range-row">';
  html += '<div class="form-group"><label>Zaƒç√°tek</label><input type="date" id="prog-start" value="' + pStart + '" onchange="saveProgramRange()"></div>';
  html += '<div class="form-group"><label>Konec</label><input type="date" id="prog-end" value="' + pEnd + '" onchange="saveProgramRange()"></div>';
  html += '</div>';

  // Info row
  html += '<div class="program-info-row">' + days.length + ' dn≈Ø &middot; Vybr√°no: <strong>' + formatDateShort(scheduleDate) + '</strong></div>';

  // Variant toggle
  html += '<div class="variant-toggle">';
  html += '<button class="' + (scheduleDayVariant === 'strip' ? 'active' : '') + '" onclick="scheduleDayVariant=\'strip\';renderAdminSchedule()">&#9776; P√°s</button>';
  html += '<button class="' + (scheduleDayVariant === 'grid' ? 'active' : '') + '" onclick="scheduleDayVariant=\'grid\';renderAdminSchedule()">&#9638; M≈ô√≠≈æka</button>';
  html += '</div>';

  // Day tiles
  const containerClass = scheduleDayVariant === 'strip' ? 'day-selector-strip' : 'day-selector-grid';
  html += '<div class="' + containerClass + '" id="day-tiles-container">';
  days.forEach(d => {
    const summary = getDaySummary(data, d);
    const dayNum = parseInt(d.split('-')[2], 10);
    const abbr = getDayAbbr(d);
    const dow = new Date(d + 'T00:00:00').getDay();
    const isWeekend = dow === 0 || dow === 6;
    const isSelected = d === scheduleDate;
    const isToday = d === today;

    let cls = 'day-tile';
    if (isSelected) cls += ' selected';
    if (summary.hasSchedule) cls += ' has-schedule';
    if (isWeekend) cls += ' weekend';
    if (isToday) cls += ' today-marker';

    html += '<div class="' + cls + '" data-date="' + d + '" onclick="scheduleDate=\'' + d + '\';renderAdminSchedule()">';
    html += '<span class="day-num">' + dayNum + '</span>';
    html += '<span class="day-abbr">' + abbr + '</span>';
    if (summary.activityCount > 0) {
      html += '<span class="day-act-count">' + summary.activityCount + ' akt.</span>';
    }
    html += '</div>';
  });
  html += '</div>';
  html += '</div>';

  // ---- Card 2: Detail selected day ----
  const sched = data.schedule[scheduleDate] || null;
  const selDayNum = parseInt(scheduleDate.split('-')[2], 10);
  const selMonth = parseInt(scheduleDate.split('-')[1], 10);
  const selYear = scheduleDate.split('-')[0];

  html += '<div class="card">';
  html += '<h2 style="margin-bottom:12px">&#128197; ' + selDayNum + '.' + selMonth + '.' + selYear + ' &middot; ' + getDayAbbr(scheduleDate) + '</h2>';

  // Time slot
  const timeVal = sched && sched.timeSlot ? esc(sched.timeSlot) : '13:30‚Äì14:30';
  html += '<div class="form-group"><label>ƒåasov√Ω slot</label><input type="text" id="sched-timeslot" value="' + timeVal + '" placeholder="13:30‚Äì14:30"></div>';

  // Educator checkboxes
  if (data.educators.length === 0) {
    html += '<div class="info-box">Nejprve p≈ôidejte vychovatelky v z√°lo≈æce "Vychovatelky".</div>';
  } else {
    const sortedEducators = [...data.educators].sort((a, b) => a.name.localeCompare(b.name, 'cs'));

    // Gather selected activities for conflict checking
    const selectedActivities = sched && sched.slots ? sched.slots.map(s => s.educatorId + '::' + s.activityId) : [];
    const allSelectedSlots = [];
    const selectedLocations = {};
    sortedEducators.forEach(edu => {
      if (!edu.activityIds) return;
      edu.activityIds.forEach(actId => {
        const key = edu.id + '::' + actId;
        if (selectedActivities.includes(key)) {
          const act = getActivity(data, actId);
          if (act) allSelectedSlots.push({ eduId: edu.id, act, key });
        }
      });
    });
    allSelectedSlots.forEach(s => {
      if (!selectedLocations[s.act.locationId]) selectedLocations[s.act.locationId] = [];
      selectedLocations[s.act.locationId].push(s.act.name);
    });
    const conflictLocations = {};
    let hasConflict = false;
    for (const locId in selectedLocations) {
      if (selectedLocations[locId].length > 1) { conflictLocations[locId] = true; hasConflict = true; }
    }

    html += '<h3 class="mb-8">Kdo dnes pracuje?</h3>';
    html += '<div class="edu-check-grid">';
    sortedEducators.forEach(edu => {
      const isChecked = sched && ((sched.slots && sched.slots.some(s => s.educatorId === edu.id)) || (sched.checkedEducators && sched.checkedEducators.includes(edu.id)));
      html += '<div class="edu-check-card' + (isChecked ? ' checked' : '') + '" onclick="toggleScheduleEducator(\'' + edu.id + '\',event)">';
      html += '<div class="edu-check-header"><input type="checkbox" data-eduid="' + edu.id + '" ' + (isChecked ? 'checked' : '') + ' onclick="event.stopPropagation();toggleScheduleEducator(\'' + edu.id + '\',event)"> ' + esc(edu.name) + ' <span style="color:var(--gray);font-weight:400;font-size:.75rem">(' + (edu.activityIds ? edu.activityIds.length : 0) + ' aktivit)</span></div>';
      if (isChecked && edu.activityIds && edu.activityIds.length > 0) {
        html += '<div class="edu-inline-activities">';
        edu.activityIds.forEach(actId => {
          const act = getActivity(data, actId);
          if (!act) return;
          const key = edu.id + '::' + actId;
          const isSelected = selectedActivities.includes(key);
          const isConfl = isSelected && conflictLocations[act.locationId];
          const ptsClass = act.points <= 10 ? 'pts-10' : act.points <= 20 ? 'pts-20' : 'pts-30';
          const chipClass = isSelected ? ptsClass : 'inactive';
          const conflStyle = isConfl ? ';outline:2px solid var(--red)' : '';
          html += '<span class="edu-chip ' + chipClass + '" style="' + conflStyle + '" onclick="event.stopPropagation();toggleScheduleSlot(\'' + edu.id + '\',\'' + actId + '\')" title="' + getLocationName(data, act.locationId) + ' ¬∑ max ' + act.maxKids + '">' + (act.icon || 'üèÉ') + ' ' + esc(act.name) + ' (' + act.points + 'b)</span>';
        });
        html += '</div>';
      }
      html += '</div>';
    });
    html += '</div>';

    if (hasConflict) {
      html += '<div class="warning-box">&#9888;&#65039; Nƒõkter√© aktivity sd√≠lej√≠ stejnou lokaci. M≈Ø≈æete p≈ôesto ulo≈æit, pokud je to z√°mƒõr.</div>';
    }
    if (allSelectedSlots.length > 4) {
      html += '<div class="warning-box">V√≠ce ne≈æ 4 aktivity za den. Aktu√°lnƒõ vybr√°no: ' + allSelectedSlots.length + '</div>';
    }

    html += '<button class="btn btn-green btn-block mt-12" onclick="saveSchedule()">Ulo≈æit rozvrh</button>';
    if (sched && sched.slots && sched.slots.length > 0) {
      html += '<button class="btn btn-red btn-block btn-sm mt-8" onclick="clearSchedule()">Smazat rozvrh pro tento den</button>';
    }

    // Show current signups ‚Äî detailed overview
    if (sched && sched.slots && sched.slots.length > 0) {
      html += '<div class="divider"></div><h3 class="mb-8">P≈ôehled obsazenosti</h3>';
      const signedUpIds = new Set();
      sched.slots.forEach(slot => {
        const act = getActivity(data, slot.activityId);
        const actName = act ? act.name : '?';
        const signups = getActivitySignups(data, scheduleDate, slot.activityId);
        const children = data.children.filter(c => {
          const r = c.records && c.records[scheduleDate];
          return r && r.activity && r.activity.activityId === slot.activityId;
        });
        children.forEach(c => signedUpIds.add(c.id));
        const ptsClass = slot.points <= 10 ? 'pts-10' : slot.points <= 20 ? 'pts-20' : 'pts-30';
        const fullCls = signups >= slot.maxKids ? ' full' : '';
        html += '<div class="overview-slot ' + ptsClass + '">';
        html += '<div class="overview-slot-header"><strong>' + (slot.icon || 'üèÉ') + ' ' + esc(actName) + '</strong>';
        html += '<span class="overview-slot-count' + fullCls + '">' + signups + '/' + slot.maxKids + '</span></div>';
        html += '<div class="overview-slot-edu">üë©‚Äçüè´ ' + esc(getEducatorName(data, slot.educatorId)) + '</div>';
        if (children.length > 0) {
          html += '<div class="overview-children">';
          children.forEach(c => {
            const av = c.photo ? '<img src="' + c.photo + '" alt="">' : (c.gender === 'kluk' ? 'üßí' : 'üëß');
            html += '<div class="overview-child"><div class="avatar">' + av + '</div><span>' + esc(c.name) + '</span></div>';
          });
          html += '</div>';
        } else {
          html += '<div style="font-size:.8rem;color:var(--gray)">Zat√≠m nikdo</div>';
        }
        html += '</div>';
      });
      // Unsigned children
      const unsigned = data.children.filter(c => !signedUpIds.has(c.id));
      if (unsigned.length > 0) {
        html += '<div style="margin-top:12px"><h3 style="color:var(--red);margin-bottom:8px">Bez aktivity (' + unsigned.length + ')</h3>';
        html += '<div class="overview-unsigned">';
        unsigned.forEach(c => {
          const av = c.photo ? '<img src="' + c.photo + '" alt="">' : (c.gender === 'kluk' ? 'üßí' : 'üëß');
          html += '<div class="overview-child"><div class="avatar">' + av + '</div><span>' + esc(c.name) + '</span></div>';
        });
        html += '</div></div>';
      }
    }
  }
  html += '</div>';
  container.innerHTML = html;

  // Scroll to selected day in strip variant
  if (scheduleDayVariant === 'strip') {
    const sel = document.querySelector('.day-tile.selected');
    if (sel) sel.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
  }
}

function toggleScheduleEducator(eduId, event) {
  const data = loadData();
  if (!data.schedule[scheduleDate]) data.schedule[scheduleDate] = { timeSlot: '13:30‚Äì14:30', slots: [] };
  const sched = data.schedule[scheduleDate];
  const hasSlots = sched.slots.some(s => s.educatorId === eduId);
  if (hasSlots) {
    // Uncheck ‚Äî remove all slots for this educator
    sched.slots = sched.slots.filter(s => s.educatorId !== eduId);
  } else {
    // Check ‚Äî no auto-select, just mark as working (will show chips)
    // Add a placeholder so the educator shows as checked
    const edu = data.educators.find(e => e.id === eduId);
    if (edu && edu.activityIds && edu.activityIds.length > 0) {
      // Just mark as checked by keeping empty ‚Äî we track via sched.checkedEducators
    }
  }
  // Track checked educators separately from activity slots
  if (!sched.checkedEducators) sched.checkedEducators = [];
  const ceIdx = sched.checkedEducators.indexOf(eduId);
  if (ceIdx >= 0) {
    sched.checkedEducators.splice(ceIdx, 1);
  } else {
    sched.checkedEducators.push(eduId);
  }
  saveData(data);
  renderAdminSchedule();
}

function toggleScheduleSlot(eduId, actId) {
  const data = loadData();
  if (!data.schedule[scheduleDate]) data.schedule[scheduleDate] = { timeSlot: '13:30‚Äì14:30', slots: [] };
  const sched = data.schedule[scheduleDate];
  const idx = sched.slots.findIndex(s => s.educatorId === eduId && s.activityId === actId);
  if (idx >= 0) {
    // Deselect ‚Äî remove this slot
    sched.slots.splice(idx, 1);
  } else {
    // Select ‚Äî remove any existing slot for this educator first (radio behavior)
    sched.slots = sched.slots.filter(s => s.educatorId !== eduId);
    const act = getActivity(data, actId);
    if (!act) return;
    sched.slots.push({
      educatorId: eduId,
      activityId: act.id,
      points: act.points,
      icon: act.icon,
      locationId: act.locationId,
      maxKids: act.maxKids
    });
  }
  saveData(data);
  renderAdminSchedule();
}

function saveSchedule() {
  const data = loadData();
  const timeSlot = document.getElementById('sched-timeslot').value.trim() || '13:30‚Äì14:30';
  if (data.schedule[scheduleDate]) {
    data.schedule[scheduleDate].timeSlot = timeSlot;
  }
  saveData(data);
  toast('Rozvrh ulo≈æen');
  renderAdminSchedule();
}

function clearSchedule() {
  if (!confirm('Smazat rozvrh pro ' + formatDate(scheduleDate) + '?')) return;
  const data = loadData();
  delete data.schedule[scheduleDate];
  saveData(data);
  toast('Rozvrh smaz√°n');
  renderAdminSchedule();
}

function exportScheduleExcel() {
  const data = loadData();
  const days = getDaysBetween(data.settings.programStart, data.settings.programEnd);
  const dayNames = ['Ne','Po','√öt','St','ƒåt','P√°','So'];
  const educators = [...data.educators].sort((a, b) => a.name.localeCompare(b.name, 'cs'));

  // Header row
  const header = ['Datum', 'Den'];
  educators.forEach(e => header.push(e.name));
  const aoa = [header];

  // Data rows
  days.forEach(d => {
    const parts = d.split('-');
    const dateLabel = parseInt(parts[2],10) + '.' + parseInt(parts[1],10) + '.' + parts[0];
    const dow = dayNames[new Date(d + 'T00:00:00').getDay()];
    const row = [dateLabel, dow];
    const sched = data.schedule[d];
    educators.forEach(edu => {
      let actName = '';
      if (sched && sched.slots) {
        const slot = sched.slots.find(s => s.educatorId === edu.id);
        if (slot) {
          const act = getActivity(data, slot.activityId);
          if (act) actName = act.name;
        }
      }
      row.push(actName);
    });
    aoa.push(row);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  // Column widths
  ws['!cols'] = [{ wch: 12 }, { wch: 4 }];
  educators.forEach(() => ws['!cols'].push({ wch: 20 }));
  XLSX.utils.book_append_sheet(wb, ws, 'Rozvrh');
  XLSX.writeFile(wb, 'rozvrh_kretin.xlsx');
}

function saveProgramRange() {
  const startEl = document.getElementById('prog-start');
  const endEl = document.getElementById('prog-end');
  if (!startEl || !endEl) return;
  const s = startEl.value;
  const e = endEl.value;
  if (!s || !e) return;
  if (s > e) { toast('Zaƒç√°tek mus√≠ b√Ωt p≈ôed koncem'); return; }
  const data = loadData();
  data.settings.programStart = s;
  data.settings.programEnd = e;
  // Adjust scheduleDate if out of range
  if (scheduleDate < s) scheduleDate = s;
  if (scheduleDate > e) scheduleDate = e;
  saveData(data);
  renderAdminSchedule();
}

// ---- ACTIVITIES TAB (global catalog) ----
function renderAdminActivities() {
  const data = loadData();
  const container = document.getElementById('admin-tab-activities');
  let html = '<div class="card"><div class="flex-between mb-8"><h2 style="margin-bottom:0">Katalog aktivit</h2><button class="btn btn-sm btn-green" onclick="showAddGlobalActivity()">+ P≈ôidat</button></div>';
  if (data.activities.length === 0) {
    html += '<div class="empty-state"><div class="empty-icon">üèÉ</div><p>Zat√≠m ≈æ√°dn√© aktivity v katalogu.</p></div>';
  } else {
    html += '<div class="activity-grid">';
    data.activities.forEach(act => {
      const ptsClass = act.points <= 10 ? 'pts-10' : act.points <= 20 ? 'pts-20' : 'pts-30';
      const locIcon = getLocationIcon(data, act.locationId);
      const eduCount = data.educators.filter(e => e.activityIds && e.activityIds.includes(act.id)).length;
      html += '<div class="activity-tile ' + ptsClass + '" style="cursor:default">';
      html += '<span class="tile-icon">' + (act.icon || 'üèÉ') + '</span>';
      html += '<strong>' + esc(act.name) + '</strong>';
      html += '<div class="tile-meta">' + locIcon + ' ' + getLocationName(data, act.locationId) + ' ¬∑ max ' + act.maxKids + '</div>';
      html += '<div style="font-size:.75rem;font-weight:800;margin-top:2px">+' + act.points + 'b</div>';
      if (eduCount > 0) html += '<div style="font-size:.65rem;color:var(--gray);margin-top:2px">üë©‚Äçüè´ ' + eduCount + '</div>';
      html += '<div style="display:flex;gap:4px;justify-content:center;margin-top:6px"><button class="btn btn-sm btn-blue" style="padding:3px 8px;font-size:.7rem" onclick="event.stopPropagation();editGlobalActivity(\'' + act.id + '\')">‚úèÔ∏è</button><button class="btn btn-sm btn-red" style="padding:3px 8px;font-size:.7rem" onclick="event.stopPropagation();deleteGlobalActivity(\'' + act.id + '\')">üóëÔ∏è</button></div>';
      html += '</div>';
    });
    html += '</div>';
  }
  html += '</div>';
  container.innerHTML = html;
}

function showAddGlobalActivity() {
  const data = loadData();
  const locOptions = data.locations.map(l => '<option value="' + l.id + '">' + l.icon + ' ' + esc(l.name) + '</option>').join('');
  const modal = document.getElementById('modal-content');
  modal.innerHTML = '<h2>P≈ôidat aktivitu</h2><div class="form-group"><label>N√°zev</label><input type="text" id="gact-name" placeholder="N√°zev aktivity"></div><div class="form-group"><label>Body</label><select id="gact-points"><option value="10">10 bod≈Ø (lehk√°)</option><option value="20">20 bod≈Ø (st≈ôedn√≠)</option><option value="30">30 bod≈Ø (n√°roƒçn√°)</option></select></div><div class="form-group"><label>Ikona (emoji)</label><input type="text" id="gact-icon" value="üèÉ" maxlength="4"></div><div class="form-group"><label>Lokace</label><select id="gact-location">' + locOptions + '</select></div><div class="form-group"><label>Max dƒõt√≠</label><input type="number" id="gact-maxkids" value="8" min="1" max="50"></div><button class="btn btn-green btn-block mt-8" onclick="saveGlobalActivity()">P≈ôidat</button><button class="btn btn-outline btn-block btn-sm mt-8" onclick="closeModal()">Zru≈°it</button>';
  openModal();
}

function saveGlobalActivity() {
  const name = document.getElementById('gact-name').value.trim();
  const points = parseInt(document.getElementById('gact-points').value);
  const icon = document.getElementById('gact-icon').value.trim() || 'üèÉ';
  const locationId = document.getElementById('gact-location').value;
  const maxKids = parseInt(document.getElementById('gact-maxkids').value) || 8;
  if (!name) { toast('Vypl≈àte n√°zev!'); return; }
  const data = loadData();
  data.activities.push({ id: genId(), name: name, points: points, icon: icon, locationId: locationId, maxKids: maxKids });
  saveData(data);
  closeModal();
  renderAdminActivities();
  toast('Aktivita p≈ôid√°na do katalogu');
}

function editGlobalActivity(actId) {
  const data = loadData();
  const act = getActivity(data, actId);
  if (!act) return;
  const locOptions = data.locations.map(l => '<option value="' + l.id + '"' + (l.id === act.locationId ? ' selected' : '') + '>' + l.icon + ' ' + esc(l.name) + '</option>').join('');
  const modal = document.getElementById('modal-content');
  modal.innerHTML = '<h2>Upravit ‚Äî ' + esc(act.name) + '</h2><div class="form-group"><label>N√°zev</label><input type="text" id="gact-edit-name" value="' + esc(act.name) + '"></div><div class="form-group"><label>Body</label><select id="gact-edit-points"><option value="10"' + (act.points === 10 ? ' selected' : '') + '>10 bod≈Ø (lehk√°)</option><option value="20"' + (act.points === 20 ? ' selected' : '') + '>20 bod≈Ø (st≈ôedn√≠)</option><option value="30"' + (act.points === 30 ? ' selected' : '') + '>30 bod≈Ø (n√°roƒçn√°)</option></select></div><div class="form-group"><label>Ikona (emoji)</label><input type="text" id="gact-edit-icon" value="' + (act.icon || 'üèÉ') + '" maxlength="4"></div><div class="form-group"><label>Lokace</label><select id="gact-edit-location">' + locOptions + '</select></div><div class="form-group"><label>Max dƒõt√≠</label><input type="number" id="gact-edit-maxkids" value="' + act.maxKids + '" min="1" max="50"></div><button class="btn btn-blue btn-block mt-8" onclick="saveEditGlobalActivity(\'' + actId + '\')">Ulo≈æit</button><button class="btn btn-outline btn-block btn-sm mt-8" onclick="closeModal()">Zru≈°it</button>';
  openModal();
}

function saveEditGlobalActivity(actId) {
  const name = document.getElementById('gact-edit-name').value.trim();
  const points = parseInt(document.getElementById('gact-edit-points').value);
  const icon = document.getElementById('gact-edit-icon').value.trim() || 'üèÉ';
  const locationId = document.getElementById('gact-edit-location').value;
  const maxKids = parseInt(document.getElementById('gact-edit-maxkids').value) || 8;
  if (!name) { toast('Vypl≈àte n√°zev!'); return; }
  const data = loadData();
  const act = getActivity(data, actId);
  if (!act) return;
  act.name = name; act.points = points; act.icon = icon; act.locationId = locationId; act.maxKids = maxKids;
  saveData(data);
  closeModal();
  renderAdminActivities();
  toast('Aktivita upravena');
}

function deleteGlobalActivity(actId) {
  const data = loadData();
  const act = getActivity(data, actId);
  if (!act) return;
  if (!confirm('Smazat aktivitu "' + act.name + '"? Bude odebr√°na i ze v≈°ech vychovatelek.')) return;
  data.activities = data.activities.filter(a => a.id !== actId);
  // Remove from educators
  data.educators.forEach(edu => {
    if (edu.activityIds) edu.activityIds = edu.activityIds.filter(id => id !== actId);
  });
  // Remove from schedules
  for (const date in data.schedule) {
    if (data.schedule[date] && data.schedule[date].slots) {
      data.schedule[date].slots = data.schedule[date].slots.filter(s => s.activityId !== actId);
    }
  }
  saveData(data);
  renderAdminActivities();
  toast('Aktivita smaz√°na');
}

// ---- EDUCATORS TAB ----
function renderAdminEducators() {
  const data = loadData();
  const container = document.getElementById('admin-tab-educators');
  let html = '<div class="card"><div class="flex-between mb-8"><h2 style="margin-bottom:0">Vychovatelky</h2><button class="btn btn-sm btn-green" onclick="showAddEducator()">+ P≈ôidat</button></div>';

  if (data.activities.length === 0) {
    html += '<div class="info-box">Nejprve vytvo≈ôte aktivity v z√°lo≈æce "Aktivity".</div>';
  }

  if (data.educators.length === 0) {
    html += '<div class="empty-state"><div class="empty-icon">üë©‚Äçüè´</div><p>Zat√≠m ≈æ√°dn√© vychovatelky.</p></div>';
  } else {
    data.educators.forEach(edu => {
      const actIds = edu.activityIds || [];
      html += '<div class="educator-card"><div class="edu-header"><span class="edu-name">' + esc(edu.name) + ' (' + actIds.length + ' aktivit)</span><div style="display:flex;gap:4px"><button class="btn btn-sm btn-blue" onclick="editEducator(\'' + edu.id + '\')">Upravit</button><button class="btn btn-sm btn-red" onclick="deleteEducator(\'' + edu.id + '\')">Smazat</button></div></div>';
      // Chip groups by points
      if (data.activities.length > 0) {
        const groups = [{pts:10,label:'10 bod≈Ø',cls:'pts-10'},{pts:20,label:'20 bod≈Ø',cls:'pts-20'},{pts:30,label:'30 bod≈Ø',cls:'pts-30'}];
        groups.forEach(g => {
          const acts = data.activities.filter(a => a.points === g.pts);
          if (acts.length === 0) return;
          html += '<div class="edu-chips-group"><div class="edu-chips-group-label">' + g.label + '</div><div class="edu-chips">';
          acts.forEach(act => {
            const isActive = actIds.includes(act.id);
            html += '<span class="edu-chip ' + (isActive ? g.cls : 'inactive') + '" onclick="toggleEducatorActivity(\'' + edu.id + '\',\'' + act.id + '\',' + !isActive + ')">' + (act.icon || 'üèÉ') + ' ' + esc(act.name) + '</span>';
          });
          html += '</div></div>';
        });
      }
      html += '</div>';
    });
  }
  html += '</div>';
  container.innerHTML = html;
}

function showAddEducator() {
  const modal = document.getElementById('modal-content');
  modal.innerHTML = '<h2>P≈ôidat vychovatelku</h2><div class="form-group"><label>Jm√©no</label><input type="text" id="edu-name" placeholder="Jm√©no vychovatelky"></div><button class="btn btn-green btn-block mt-8" onclick="saveNewEducator()">P≈ôidat</button><button class="btn btn-outline btn-block btn-sm mt-8" onclick="closeModal()">Zru≈°it</button>';
  openModal();
}

function saveNewEducator() {
  const name = document.getElementById('edu-name').value.trim();
  if (!name) { toast('Vypl≈àte jm√©no!'); return; }
  const data = loadData();
  data.educators.push({ id: genId(), name, activityIds: [] });
  saveData(data);
  closeModal();
  renderAdminEducators();
  toast('Vychovatelka p≈ôid√°na');
}

function editEducator(id) {
  const data = loadData();
  const edu = data.educators.find(e => e.id === id);
  if (!edu) return;
  const modal = document.getElementById('modal-content');
  modal.innerHTML = '<h2>Upravit ‚Äî ' + esc(edu.name) + '</h2><div class="form-group"><label>Jm√©no</label><input type="text" id="edu-edit-name" value="' + esc(edu.name) + '"></div><button class="btn btn-blue btn-block mt-8" onclick="saveEditEducator(\'' + id + '\')">Ulo≈æit</button><button class="btn btn-outline btn-block btn-sm mt-8" onclick="closeModal()">Zru≈°it</button>';
  openModal();
}

function saveEditEducator(id) {
  const name = document.getElementById('edu-edit-name').value.trim();
  if (!name) { toast('Vypl≈àte jm√©no!'); return; }
  const data = loadData();
  const edu = data.educators.find(e => e.id === id);
  if (edu) edu.name = name;
  saveData(data);
  closeModal();
  renderAdminEducators();
  toast('Ulo≈æeno');
}

function deleteEducator(id) {
  if (!confirm('Smazat tuto vychovatelku?')) return;
  const data = loadData();
  data.educators = data.educators.filter(e => e.id !== id);
  // Remove from schedules
  for (const date in data.schedule) {
    if (data.schedule[date].slots) {
      data.schedule[date].slots = data.schedule[date].slots.filter(s => s.educatorId !== id);
    }
  }
  saveData(data);
  renderAdminEducators();
  toast('Vychovatelka smaz√°na');
}

function toggleEducatorActivity(eduId, actId, checked) {
  const data = loadData();
  const edu = data.educators.find(e => e.id === eduId);
  if (!edu) return;
  if (!edu.activityIds) edu.activityIds = [];
  if (checked) {
    if (!edu.activityIds.includes(actId)) edu.activityIds.push(actId);
  } else {
    edu.activityIds = edu.activityIds.filter(id => id !== actId);
  }
  saveData(data);
  renderAdminEducators();
}

// ---- CHILDREN TAB ----
let adminChildFilter = 'all';
let adminSubFilter = 'all';

function renderAdminChildren() {
  const data = loadData();
  const container = document.getElementById('admin-tab-children');
  let children = [...data.children];

  if (adminChildFilter !== 'all') children = children.filter(c => c.group === adminChildFilter);
  if (adminSubFilter !== 'all') children = children.filter(c => c.subgroup === adminSubFilter);

  let html = '<div class="card"><div class="flex-between mb-8"><h2 style="margin-bottom:0">Dƒõti (' + data.children.length + ')</h2><button class="btn btn-sm btn-green" onclick="showAdminAddChild()">+ P≈ôidat</button></div>';

  // Filters
  html += '<div class="filter-bar">';
  html += '<button class="filter-btn ' + (adminChildFilter === 'all' ? 'active' : '') + '" onclick="adminChildFilter=\'all\';renderAdminChildren()">V≈°echny</button>';
  data.settings.groups.forEach(g => {
    html += '<button class="filter-btn ' + (adminChildFilter === g ? 'active' : '') + '" onclick="adminChildFilter=\'' + esc(g) + '\';renderAdminChildren()">' + esc(g) + '</button>';
  });
  html += '</div>';
  html += '<div class="filter-bar">';
  html += '<button class="filter-btn ' + (adminSubFilter === 'all' ? 'active' : '') + '" onclick="adminSubFilter=\'all\';renderAdminChildren()">V≈°echny</button>';
  data.settings.subgroups.forEach(s => {
    html += '<button class="filter-btn ' + (adminSubFilter === s ? 'active' : '') + '" onclick="adminSubFilter=\'' + esc(s) + '\';renderAdminChildren()">' + esc(s) + '</button>';
  });
  html += '</div>';

  if (children.length === 0) {
    html += '<div class="empty-state"><div class="empty-icon">üë∂</div><p>≈Ω√°dn√© dƒõti.</p></div>';
  } else {
    children.forEach(c => {
      const pts = getTotalPoints(c);
      const days = Object.keys(c.records || {}).sort();
      let daysHtml = '';
      if (days.length > 0) {
        daysHtml = days.map(day => {
          const rec = c.records[day];
          const actTag = rec.activity ? (() => {
            const cls = rec.activity.points <= 10 ? 'tag-green' : rec.activity.points <= 20 ? 'tag-orange' : 'tag-purple';
            return '<span class="tag ' + cls + '">' + (rec.activity.icon || 'üèÉ') + ' ' + esc(rec.activity.name) + ' (+' + rec.activity.points + 'b) <span class="remove-tag" onclick="adminRemoveActivity(\'' + c.id + '\',\'' + day + '\')">‚úï</span></span>';
          })() : '';
          const kmTag = rec.km > 0 ? '<span class="tag tag-blue">' + rec.km + ' km <span class="remove-tag" onclick="adminRemoveKm(\'' + c.id + '\',\'' + day + '\')">‚úï</span></span>' : '';
          if (!actTag && !kmTag) return '';
          return '<div class="admin-day-record"><strong>' + formatDateShort(day) + '</strong> ' + actTag + ' ' + kmTag + '</div>';
        }).filter(Boolean).join('');
      }
      if (!daysHtml) daysHtml = '<p style="font-size:.8rem;color:var(--gray);padding:4px 0">≈Ω√°dn√© z√°znamy</p>';

      html += '<details class="admin-record"><summary>' + esc(c.name) + ' ‚Äî ' + esc(c.group) + '/' + esc(c.subgroup) + ' ‚Äî ' + pts + 'b';
      html += '<button class="btn btn-sm btn-red" style="float:right;padding:2px 8px;font-size:.75rem" onclick="event.stopPropagation();adminDeleteChild(\'' + c.id + '\')">Smazat</button>';
      html += '<button class="btn btn-sm btn-blue" style="float:right;padding:2px 8px;font-size:.75rem;margin-right:4px" onclick="event.stopPropagation();adminEditChild(\'' + c.id + '\')">Upravit</button>';
      html += '<button class="btn btn-sm btn-green" style="float:right;padding:2px 8px;font-size:.75rem;margin-right:4px" onclick="event.stopPropagation();adminAddRecord(\'' + c.id + '\')">+ Z√°znam</button>';
      html += '<button class="btn btn-sm" style="float:right;padding:2px 8px;font-size:.75rem;margin-right:4px;background:#FF8F00;color:#fff" onclick="event.stopPropagation();adminResetPin(\'' + c.id + '\')">üîë PIN</button>';
      html += '</summary><div style="margin-top:8px">' + daysHtml + '</div></details>';
    });
  }
  html += '</div>';
  container.innerHTML = html;
}

function adminDeleteChild(id) {
  if (!confirm('Opravdu smazat toto d√≠tƒõ?')) return;
  const data = loadData();
  data.children = data.children.filter(c => c.id !== id);
  saveData(data);
  renderAdminChildren();
  toast('D√≠tƒõ smaz√°no');
}

function adminRemoveActivity(childId, day) {
  const data = loadData();
  const child = data.children.find(c => c.id === childId);
  if (!child || !child.records[day]) return;
  child.records[day].activity = null;
  saveData(data);
  renderAdminChildren();
  toast('Aktivita odebr√°na');
}

function adminRemoveKm(childId, day) {
  const data = loadData();
  const child = data.children.find(c => c.id === childId);
  if (!child || !child.records[day]) return;
  child.records[day].km = 0;
  saveData(data);
  renderAdminChildren();
  toast('Kilometry odebr√°ny');
}

function adminEditChild(id) {
  const data = loadData();
  const child = data.children.find(c => c.id === id);
  if (!child) return;
  const groupOpts = data.settings.groups.map(g => '<option value="' + esc(g) + '" ' + (child.group === g ? 'selected' : '') + '>' + esc(g) + '</option>').join('');
  const subOpts = data.settings.subgroups.map(s => '<option value="' + esc(s) + '" ' + (child.subgroup === s ? 'selected' : '') + '>' + esc(s) + '</option>').join('');
  const modal = document.getElementById('modal-content');
  modal.innerHTML = '<h2>Upravit ‚Äî ' + esc(child.name) + '</h2><div class="form-group"><label>Jm√©no</label><input type="text" id="edit-name" value="' + esc(child.name) + '"></div><div class="form-group"><label>Vƒõk</label><input type="number" id="edit-age" value="' + child.age + '" min="4" max="18"></div><div class="form-group"><label>Pohlav√≠</label><select id="edit-gender"><option value="kluk" ' + (child.gender === 'kluk' ? 'selected' : '') + '>Kluk</option><option value="holka" ' + (child.gender === 'holka' ? 'selected' : '') + '>Holka</option></select></div><div class="form-group"><label>Skupina</label><select id="edit-group">' + groupOpts + '</select></div><div class="form-group"><label>Podskupina</label><select id="edit-subgroup">' + subOpts + '</select></div><div class="form-group"><label>Nov√Ω PIN (pr√°zdn√©=ponechat)</label><input type="password" id="edit-pin" placeholder="Nov√Ω PIN" maxlength="4"></div><button class="btn btn-blue btn-block mt-8" onclick="saveEditChild(\'' + id + '\')">Ulo≈æit</button><button class="btn btn-outline btn-block btn-sm mt-8" onclick="closeModal()">Zru≈°it</button>';
  openModal();
}

function saveEditChild(id) {
  const data = loadData();
  const child = data.children.find(c => c.id === id);
  if (!child) return;
  child.name = document.getElementById('edit-name').value.trim() || child.name;
  child.age = parseInt(document.getElementById('edit-age').value) || child.age;
  child.gender = document.getElementById('edit-gender').value;
  child.group = document.getElementById('edit-group').value;
  child.subgroup = document.getElementById('edit-subgroup').value;
  const newPin = document.getElementById('edit-pin').value.trim();
  if (newPin && /^\d{4}$/.test(newPin)) child.pin = newPin;
  saveData(data);
  closeModal();
  renderAdminChildren();
  toast('Ulo≈æeno');
}

function adminResetPin(id) {
  const data = loadData();
  const child = data.children.find(c => c.id === id);
  if (!child) return;
  const modal = document.getElementById('modal-content');
  modal.innerHTML = '<h2>Nov√Ω PIN ‚Äî ' + esc(child.name) + '</h2><div class="form-group"><label>Nov√Ω PIN (4 ƒç√≠slice)</label><input type="password" id="reset-pin-input" maxlength="4" inputmode="numeric" placeholder="1234"></div><button class="btn btn-blue btn-block mt-8" onclick="saveResetPin(\'' + id + '\')">Ulo≈æit PIN</button><button class="btn btn-outline btn-block btn-sm mt-8" onclick="closeModal()">Zru≈°it</button>';
  openModal();
}

function saveResetPin(id) {
  const pin = document.getElementById('reset-pin-input').value.trim();
  if (!pin || !/^\d{4}$/.test(pin)) { toast('PIN mus√≠ b√Ωt 4 ƒç√≠slice!'); return; }
  const data = loadData();
  const child = data.children.find(c => c.id === id);
  if (!child) return;
  child.pin = pin;
  saveData(data);
  closeModal();
  toast('PIN zmƒõnƒõn pro ' + child.name);
}

function showAdminAddChild() {
  const data = loadData();
  const groupOpts = data.settings.groups.map(g => '<option value="' + esc(g) + '">' + esc(g) + '</option>').join('');
  const subOpts = data.settings.subgroups.map(s => '<option value="' + esc(s) + '">' + esc(s) + '</option>').join('');
  const modal = document.getElementById('modal-content');
  modal.innerHTML = '<h2>P≈ôidat d√≠tƒõ</h2><div class="form-group"><label>Jm√©no</label><input type="text" id="add-name" maxlength="30"></div><div class="form-group"><label>Pohlav√≠</label><select id="add-gender"><option value="kluk">Kluk</option><option value="holka">Holka</option></select></div><div class="form-group"><label>Vƒõk</label><input type="number" id="add-age" min="4" max="18"></div><div class="form-group"><label>Skupina</label><select id="add-group">' + groupOpts + '</select></div><div class="form-group"><label>Podskupina</label><select id="add-subgroup">' + subOpts + '</select></div><div class="form-group"><label>PIN</label><input type="password" id="add-pin" maxlength="4" placeholder="1234"></div><button class="btn btn-green btn-block mt-8" onclick="adminSaveNewChild()">P≈ôidat</button><button class="btn btn-outline btn-block btn-sm mt-8" onclick="closeModal()">Zru≈°it</button>';
  openModal();
}

function adminSaveNewChild() {
  const name = document.getElementById('add-name').value.trim();
  const gender = document.getElementById('add-gender').value;
  const age = parseInt(document.getElementById('add-age').value);
  const group = document.getElementById('add-group').value;
  const subgroup = document.getElementById('add-subgroup').value;
  const pin = document.getElementById('add-pin').value.trim();
  if (!name) { toast('Vypl≈àte jm√©no!'); return; }
  if (!age || age < 4 || age > 18) { toast('Vƒõk 4‚Äì18!'); return; }
  if (!pin || !/^\d{4}$/.test(pin)) { toast('PIN mus√≠ b√Ωt 4 ƒç√≠slice!'); return; }
  const data = loadData();
  data.children.push({ id: genId(), name, gender, age, group, subgroup, pin, photo: null, records: {} });
  saveData(data);
  closeModal();
  renderAdminChildren();
  toast('D√≠tƒõ p≈ôid√°no');
}

function adminAddRecord(id) {
  const data = loadData();
  const child = data.children.find(c => c.id === id);
  if (!child) return;

  // Use global activity catalog
  const actOptions = data.activities.length > 0
    ? data.activities.map(a => '<option value="' + a.id + '">' + (a.icon || 'üèÉ') + ' ' + esc(a.name) + ' (' + a.points + 'b)</option>').join('')
    : '<option value="">≈Ω√°dn√© aktivity</option>';

  const modal = document.getElementById('modal-content');
  modal.innerHTML = '<h2>P≈ôidat z√°znam ‚Äî ' + esc(child.name) + '</h2><div class="form-group"><label>Datum</label><input type="date" id="rec-date" value="' + getToday() + '"></div><div class="form-group"><label>Aktivita</label><select id="rec-activity"><option value="">-- vyberte --</option>' + actOptions + '</select></div><button class="btn btn-green btn-block mt-8" onclick="saveAdminRecord(\'' + id + '\')">P≈ôidat aktivitu</button><div class="divider"></div><div class="form-group"><label>Kilometry</label><input type="number" id="rec-km" min="0" max="20" step="0.5" placeholder="0"></div><button class="btn btn-blue btn-block" onclick="saveAdminKm(\'' + id + '\')">Nastavit km</button><button class="btn btn-outline btn-block btn-sm mt-12" onclick="closeModal()">Zav≈ô√≠t</button>';
  openModal();
}

function saveAdminRecord(id) {
  const data = loadData();
  const child = data.children.find(c => c.id === id);
  if (!child) return;
  const date = document.getElementById('rec-date').value;
  const actId = document.getElementById('rec-activity').value;
  if (!date || !actId) { toast('Vypl≈àte datum a aktivitu!'); return; }
  const act = getActivity(data, actId);
  if (!act) { toast('Aktivita nenalezena!'); return; }
  if (!child.records) child.records = {};
  if (!child.records[date]) child.records[date] = { activity: null, km: 0 };
  child.records[date].activity = { activityId: act.id, name: act.name, points: act.points, icon: act.icon, timestamp: 0 };
  saveData(data);
  renderAdminChildren();
  toast('Z√°znam p≈ôid√°n');
}

function saveAdminKm(id) {
  const data = loadData();
  const child = data.children.find(c => c.id === id);
  if (!child) return;
  const date = document.getElementById('rec-date').value;
  const km = parseFloat(document.getElementById('rec-km').value) || 0;
  if (!date) { toast('Vypl≈àte datum!'); return; }
  if (!child.records) child.records = {};
  if (!child.records[date]) child.records[date] = { activity: null, km: 0 };
  child.records[date].km = km;
  saveData(data);
  renderAdminChildren();
  toast('Kilometry nastaveny');
}

// ---- STATS TAB ----
function renderAdminStats() {
  const data = loadData();
  const container = document.getElementById('admin-tab-stats');
  const totalChildren = data.children.length;
  let totalPts = 0, totalActiveDays = 0, totalKm = 0;
  const activityCounts = {};
  const dailyPoints = {};

  data.children.forEach(child => {
    if (!child.records) return;
    for (const day in child.records) {
      const r = child.records[day];
      let dayPts = 0;
      if (r.activity) {
        dayPts += r.activity.points;
        const aName = r.activity.name;
        activityCounts[aName] = (activityCounts[aName] || 0) + 1;
      }
      if (r.activities) r.activities.forEach(a => {
        dayPts += a.points;
        activityCounts[a.name] = (activityCounts[a.name] || 0) + 1;
      });
      if (r.km) { dayPts += r.km; totalKm += r.km; }
      if (dayPts > 0) {
        totalActiveDays++;
        totalPts += dayPts;
        dailyPoints[day] = (dailyPoints[day] || 0) + dayPts;
      }
    }
  });

  let html = '<div class="card"><h2>Statistiky</h2>';
  html += '<div class="stat-grid"><div class="stat-card" style="background:var(--blue-light)"><span class="stat-num" style="color:var(--blue)">' + totalChildren + '</span><span class="stat-lbl">Dƒõt√≠</span></div><div class="stat-card" style="background:var(--green-light)"><span class="stat-num" style="color:var(--green)">' + totalActiveDays + '</span><span class="stat-lbl">Aktivn√≠ch z√°pis≈Ø</span></div><div class="stat-card" style="background:var(--orange-light)"><span class="stat-num" style="color:var(--orange)">' + totalPts + '</span><span class="stat-lbl">Celkem bod≈Ø</span></div><div class="stat-card" style="background:var(--purple-light)"><span class="stat-num" style="color:var(--purple)">' + totalKm + '</span><span class="stat-lbl">Celkem km</span></div></div>';

  // Daily points chart
  const sortedDays = Object.keys(dailyPoints).sort();
  if (sortedDays.length > 0) {
    html += '<h3 class="mb-8">Body za den</h3>';
    const maxDayPts = Math.max(...sortedDays.map(d => dailyPoints[d]));
    const chartW = 560, chartH = 150, barW = Math.max(8, Math.min(30, (chartW - 40) / sortedDays.length - 2));
    let svg = '<svg viewBox="0 0 ' + chartW + ' ' + (chartH + 30) + '" style="width:100%;height:auto;display:block">';
    svg += '<line x1="30" y1="0" x2="30" y2="' + chartH + '" stroke="#eee" stroke-width="1"/>';
    svg += '<line x1="30" y1="' + chartH + '" x2="' + chartW + '" y2="' + chartH + '" stroke="#eee" stroke-width="1"/>';
    sortedDays.forEach((day, i) => {
      const val = dailyPoints[day];
      const h = Math.max(2, (val / maxDayPts) * (chartH - 10));
      const x = 35 + i * (barW + 2);
      const y = chartH - h;
      svg += '<rect x="' + x + '" y="' + y + '" width="' + barW + '" height="' + h + '" rx="2" fill="#2196F3"/>';
      if (sortedDays.length <= 15) {
        svg += '<text x="' + (x + barW / 2) + '" y="' + (chartH + 14) + '" text-anchor="middle" font-size="8" fill="#757575">' + day.slice(8) + '.' + day.slice(5, 7) + '</text>';
      }
      svg += '<text x="' + (x + barW / 2) + '" y="' + (y - 2) + '" text-anchor="middle" font-size="7" fill="#333">' + val + '</text>';
    });
    svg += '</svg>';
    html += svg;
  }

  // Group comparison
  html += '<div class="divider"></div><h3 class="mb-8">Porovn√°n√≠ skupin</h3>';
  html += '<div class="group-comparison">';
  data.settings.groups.forEach(g => {
    const members = data.children.filter(c => c.group === g);
    const total = members.reduce((s, c) => s + getTotalPoints(c), 0);
    const avg = members.length > 0 ? (total / members.length).toFixed(1) : 0;
    html += '<div class="group-card" style="background:var(--gray-light)"><div class="group-name">' + esc(g) + '</div><div class="group-pts">' + total + 'b</div><div class="group-avg">' + members.length + ' dƒõt√≠ ¬∑ √ò ' + avg + 'b</div></div>';
  });
  html += '</div>';

  // Subgroup comparison
  html += '<h3 class="mb-8">Porovn√°n√≠ podskupin</h3>';
  html += '<div class="group-comparison" style="grid-template-columns:repeat(' + Math.min(data.settings.subgroups.length, 3) + ',1fr)">';
  data.settings.subgroups.forEach(s => {
    const members = data.children.filter(c => c.subgroup === s);
    const total = members.reduce((sum, c) => sum + getTotalPoints(c), 0);
    const avg = members.length > 0 ? (total / members.length).toFixed(1) : 0;
    html += '<div class="group-card" style="background:var(--gray-light)"><div class="group-name">' + esc(s) + '</div><div class="group-pts">' + total + 'b</div><div class="group-avg">' + members.length + ' dƒõt√≠ ¬∑ √ò ' + avg + 'b</div></div>';
  });
  html += '</div>';

  // Popular activities
  const sortedActs = Object.entries(activityCounts).sort((a, b) => b[1] - a[1]);
  if (sortedActs.length > 0) {
    html += '<div class="divider"></div><h3 class="mb-8">Nejobl√≠benƒõj≈°√≠ aktivity</h3>';
    sortedActs.slice(0, 10).forEach(([name, count], i) => {
      html += '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f0f0f0;font-size:.9rem"><span>' + (i + 1) + '. ' + esc(name) + '</span><strong>' + count + '√ó</strong></div>';
    });
  }

  html += '<div class="divider"></div><button class="btn btn-orange btn-block" onclick="exportData()">üì• Export dat (JSON)</button>';
  html += '</div>';
  container.innerHTML = html;
}

function exportData() {
  const data = loadData();
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'kretin_v2_' + getToday() + '.json';
  a.click();
  URL.revokeObjectURL(url);
  toast('Data exportov√°na');
}

// ---- SETTINGS TAB ----
function renderAdminSettings() {
  const data = loadData();
  const container = document.getElementById('admin-tab-settings');

  let html = '<div class="card"><h2>Nastaven√≠</h2>';

  // Locations
  html += '<h3 class="mb-8">Lokace</h3>';
  data.locations.forEach((loc, i) => {
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f0f0f0"><span>' + loc.icon + ' ' + esc(loc.name) + '</span><button class="btn btn-sm btn-red" style="padding:2px 8px;font-size:.7rem" onclick="removeLocation(' + i + ')">‚úï</button></div>';
  });
  html += '<div class="flex-between mt-8"><input type="text" id="new-loc-icon" placeholder="üè†" style="width:50px;padding:8px;border:2px solid #E0E0E0;border-radius:var(--radius-sm);text-align:center" maxlength="4"><input type="text" id="new-loc-name" placeholder="N√°zev lokace" style="flex:1;margin:0 8px;padding:8px;border:2px solid #E0E0E0;border-radius:var(--radius-sm)"><button class="btn btn-sm btn-green" onclick="addLocation()">+</button></div>';

  html += '<div class="divider"></div>';

  // Groups
  html += '<h3 class="mb-8">Skupiny</h3>';
  data.settings.groups.forEach((g, i) => {
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f0f0f0"><span>' + esc(g) + '</span><button class="btn btn-sm btn-red" style="padding:2px 8px;font-size:.7rem" onclick="removeGroup(' + i + ')">‚úï</button></div>';
  });
  html += '<div class="flex-between mt-8"><input type="text" id="new-group" placeholder="Nov√° skupina" style="flex:1;margin-right:8px;padding:8px;border:2px solid #E0E0E0;border-radius:var(--radius-sm)"><button class="btn btn-sm btn-green" onclick="addGroup()">+</button></div>';

  html += '<div class="divider"></div>';

  // Subgroups
  html += '<h3 class="mb-8">Podskupiny</h3>';
  data.settings.subgroups.forEach((s, i) => {
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f0f0f0"><span>' + esc(s) + '</span><button class="btn btn-sm btn-red" style="padding:2px 8px;font-size:.7rem" onclick="removeSubgroup(' + i + ')">‚úï</button></div>';
  });
  html += '<div class="flex-between mt-8"><input type="text" id="new-subgroup" placeholder="Nov√° podskupina" style="flex:1;margin-right:8px;padding:8px;border:2px solid #E0E0E0;border-radius:var(--radius-sm)"><button class="btn btn-sm btn-green" onclick="addSubgroup()">+</button></div>';

  html += '<div class="divider"></div>';

  // Admin password
  html += '<h3 class="mb-8">Admin heslo</h3>';
  html += '<div class="form-group"><input type="password" id="new-admin-pass" placeholder="Zadejte nov√© heslo"></div>';
  html += '<button class="btn btn-sm btn-blue mb-16" onclick="saveAdminPassword()">Zmƒõnit heslo</button>';

  // KM cutoff
  html += '<h3 class="mb-8">Uz√°vƒõrka km</h3>';
  html += '<div class="form-group"><label>Hodina uz√°vƒõrky (0‚Äì23)</label><input type="number" id="km-cutoff" value="' + data.settings.kmCutoffHour + '" min="0" max="23"></div>';
  html += '<button class="btn btn-sm btn-blue mb-16" onclick="saveKmCutoff()">Ulo≈æit</button>';

  // Cancel before start
  html += '<h3 class="mb-8">Uz√°vƒõrka na zmƒõnu aktivity</h3>';
  html += '<div class="form-group"><label>Minut p≈ôed zaƒç√°tkem aktivity</label><input type="number" id="cancel-before-start" value="' + (data.settings.cancelBeforeStartMinutes || 30) + '" min="5" max="1440"></div>';
  html += '<button class="btn btn-sm btn-blue" onclick="saveCancelBeforeStart()">Ulo≈æit</button>';

  html += '</div>';
  container.innerHTML = html;
}

function addLocation() {
  const icon = document.getElementById('new-loc-icon').value.trim() || 'üìç';
  const name = document.getElementById('new-loc-name').value.trim();
  if (!name) { toast('Vypl≈àte n√°zev!'); return; }
  const data = loadData();
  const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
  data.locations.push({ id, name, icon });
  saveData(data);
  renderAdminSettings();
  toast('Lokace p≈ôid√°na');
}

function removeLocation(i) {
  const data = loadData();
  if (data.locations.length <= 1) { toast('Mus√≠ z≈Østat alespo≈à 1 lokace!'); return; }
  data.locations.splice(i, 1);
  saveData(data);
  renderAdminSettings();
  toast('Lokace odebr√°na');
}

function addGroup() {
  const name = document.getElementById('new-group').value.trim();
  if (!name) { toast('Vypl≈àte n√°zev!'); return; }
  const data = loadData();
  if (data.settings.groups.includes(name)) { toast('Skupina ji≈æ existuje!'); return; }
  data.settings.groups.push(name);
  saveData(data);
  renderAdminSettings();
  toast('Skupina p≈ôid√°na');
}

function removeGroup(i) {
  const data = loadData();
  if (data.settings.groups.length <= 1) { toast('Mus√≠ z≈Østat alespo≈à 1 skupina!'); return; }
  data.settings.groups.splice(i, 1);
  saveData(data);
  renderAdminSettings();
  toast('Skupina odebr√°na');
}

function addSubgroup() {
  const name = document.getElementById('new-subgroup').value.trim();
  if (!name) { toast('Vypl≈àte n√°zev!'); return; }
  const data = loadData();
  if (data.settings.subgroups.includes(name)) { toast('Podskupina ji≈æ existuje!'); return; }
  data.settings.subgroups.push(name);
  saveData(data);
  renderAdminSettings();
  toast('Podskupina p≈ôid√°na');
}

function removeSubgroup(i) {
  const data = loadData();
  if (data.settings.subgroups.length <= 1) { toast('Mus√≠ z≈Østat alespo≈à 1 podskupina!'); return; }
  data.settings.subgroups.splice(i, 1);
  saveData(data);
  renderAdminSettings();
  toast('Podskupina odebr√°na');
}

async function saveAdminPassword() {
  const pass = document.getElementById('new-admin-pass').value.trim();
  if (!pass) { toast('Heslo nesm√≠ b√Ωt pr√°zdn√©!'); return; }
  const data = loadData();
  data.settings.adminPassword = await hashPassword(pass);
  saveData(data);
  toast('Heslo zmƒõnƒõno');
}

function saveKmCutoff() {
  const val = parseInt(document.getElementById('km-cutoff').value);
  if (isNaN(val) || val < 0 || val > 23) { toast('Hodina 0‚Äì23!'); return; }
  const data = loadData();
  data.settings.kmCutoffHour = val;
  saveData(data);
  toast('Uz√°vƒõrka ulo≈æena');
}

function saveCancelBeforeStart() {
  const val = parseInt(document.getElementById('cancel-before-start').value);
  if (isNaN(val) || val < 5) { toast('Min 5 minut!'); return; }
  const data = loadData();
  data.settings.cancelBeforeStartMinutes = val;
  saveData(data);
  toast('Uz√°vƒõrka ulo≈æena');
}

// ============ INIT ============
(async function init() {
  // Load from localStorage first (fast)
  if (!localStorage.getItem('kretin_v2')) {
    _cache = JSON.parse(JSON.stringify(DEFAULT_DATA));
    localStorage.setItem('kretin_v2', JSON.stringify(_cache));
  }

  // Sync from Supabase (async)
  const synced = await syncFromSupabase();
  if (synced) {
    refreshCurrentScreen();
  } else {
    // Only push to Supabase if local data is not empty (has children or educators)
    const local = loadData();
    if ((local.children && local.children.length > 0) || (local.educators && local.educators.length > 0)) {
      pushToSupabase(local);
    }
  }

  // Migrate plain text password to hash (after sync so we hash the final state)
  const initData = loadData();
  if (initData.settings.adminPassword && !isHashed(initData.settings.adminPassword)) {
    initData.settings.adminPassword = await hashPassword(initData.settings.adminPassword);
    saveData(initData);
  }

  // Realtime: when someone else saves, update local cache
  sb.channel('app_state_sync')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'app_state' }, async payload => {
      if (payload.new && payload.new.data) {
        const d = migrateData(payload.new.data);
        if (d.settings.adminPassword && !isHashed(d.settings.adminPassword)) {
          d.settings.adminPassword = await hashPassword(d.settings.adminPassword);
        }
        _cache = d;
        localStorage.setItem('kretin_v2', JSON.stringify(d));
        refreshCurrentScreen();
      }
    })
    .subscribe();

  // Click outside modal to close
  document.getElementById('modal-overlay').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
  });
})();
</script>
</body>
</html>
